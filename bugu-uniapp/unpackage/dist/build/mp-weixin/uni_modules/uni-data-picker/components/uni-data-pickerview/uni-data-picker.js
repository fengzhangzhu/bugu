"use strict";var e=require("../../../../common/vendor.js"),t={props:{localdata:{type:[Array,Object],default:()=>[]},spaceInfo:{type:Object,default:()=>({})},collection:{type:String,default:""},action:{type:String,default:""},field:{type:String,default:""},orderby:{type:String,default:""},where:{type:[String,Object],default:""},pageData:{type:String,default:"add"},pageCurrent:{type:Number,default:1},pageSize:{type:Number,default:20},getcount:{type:[Boolean,String],default:!1},getone:{type:[Boolean,String],default:!1},gettree:{type:[Boolean,String],default:!1},manual:{type:Boolean,default:!1},value:{type:[Array,String,Number],default:()=>[]},modelValue:{type:[Array,String,Number],default:()=>[]},preload:{type:Boolean,default:!1},stepSearh:{type:Boolean,default:!0},selfField:{type:String,default:""},parentField:{type:String,default:""},multiple:{type:Boolean,default:!1},map:{type:Object,default:()=>({text:"text",value:"value"})}},data(){return{loading:!1,errorMessage:"",loadMore:{contentdown:"",contentrefresh:"",contentnomore:""},dataList:[],selected:[],selectedIndex:0,page:{current:this.pageCurrent,size:this.pageSize,count:0}}},computed:{isLocaldata(){return!this.collection.length},postField(){let e=[this.field];return this.parentField&&e.push(`${this.parentField} as parent_value`),e.join(",")},dataValue(){return(Array.isArray(this.modelValue)?this.modelValue.length>0:null!==this.modelValue||void 0!==this.modelValue)?this.modelValue:this.value},hasValue(){return"number"==typeof this.dataValue||null!=this.dataValue&&this.dataValue.length>0}},created(){this.$watch((()=>{var e=[];return["pageCurrent","pageSize","spaceInfo","value","modelValue","localdata","collection","action","field","orderby","where","getont","getcount","gettree"].forEach((t=>{e.push(this[t])})),e}),((e,t)=>{for(let a=2;a<e.length&&e[a]==t[a];a++);e[0]!=t[0]&&(this.page.current=this.pageCurrent),this.page.size=this.pageSize,this.onPropsChange()})),this._treeData=[]},methods:{onPropsChange(){this._treeData=[]},getCommand(t={}){let a=e.rn.database(this.spaceInfo);const i=t.action||this.action;i&&(a=a.action(i));const l=t.collection||this.collection;a=a.collection(l);const s=t.where||this.where;s&&Object.keys(s).length&&(a=a.where(s));const r=t.field||this.field;r&&(a=a.field(r));const h=t.orderby||this.orderby;h&&(a=a.orderBy(h));const n=void 0!==t.pageCurrent?t.pageCurrent:this.page.current,d=void 0!==t.pageSize?t.pageSize:this.page.size,o={getCount:void 0!==t.getcount?t.getcount:this.getcount,getTree:void 0!==t.gettree?t.gettree:this.gettree};return t.getTreePath&&(o.getTreePath=t.getTreePath),a=a.skip(d*(n-1)).limit(d).get(o),a},getNodeData(e){this.loading||(this.loading=!0,this.getCommand({field:this.postField,where:this._pathWhere()}).then((t=>{this.loading=!1,this.selected=t.result.data,e&&e()})).catch((e=>{this.loading=!1,this.errorMessage=e})))},getTreePath(e){this.loading||(this.loading=!0,this.getCommand({field:this.postField,getTreePath:{startWith:`${this.selfField}=='${this.dataValue}'`}}).then((t=>{this.loading=!1;let a=[];this._extractTreePath(t.result.data,a),this.selected=a,e&&e()})).catch((e=>{this.loading=!1,this.errorMessage=e})))},loadData(){this.isLocaldata?this._processLocalData():null==this.dataValue?this.stepSearh?this._loadNodeData((e=>{this._treeData=e,this._updateBindData()})):this._loadAllData((e=>{this._treeData=[],this._extractTree(e,this._treeData,null),this._updateBindData()})):this._loadNodeData((e=>{this._treeData=e,this._updateBindData(),this._updateSelected()}))},_loadAllData(e){this.loading||(this.loading=!0,this.getCommand({field:this.postField,gettree:!0,startwith:`${this.selfField}=='${this.dataValue}'`}).then((t=>{this.loading=!1,e(t.result.data),this.onDataChange()})).catch((e=>{this.loading=!1,this.errorMessage=e})))},_loadNodeData(e,t){this.loading||(this.loading=!0,this.getCommand({field:this.postField,where:t||this._postWhere(),pageSize:500}).then((t=>{this.loading=!1,e(t.result.data),this.onDataChange()})).catch((e=>{this.loading=!1,this.errorMessage=e})))},_pathWhere(){let e=[],t=this._getParentNameByField();return t&&e.push(`${t} == '${this.dataValue}'`),this.where?`(${this.where}) && (${e.join(" || ")})`:e.join(" || ")},_postWhere(){let e=[],t=this.selected,a=this.parentField;if(a&&e.push(`${a} == null || ${a} == ""`),t.length)for(var i=0;i<t.length-1;i++)e.push(`${a} == '${t[i].value}'`);let l=[];return this.where&&l.push(`(${this.where})`),e.length&&l.push(`(${e.join(" || ")})`),l.join(" && ")},_nodeWhere(){let e=[],t=this.selected;return t.length&&e.push(`${this.parentField} == '${t[t.length-1].value}'`),this.where?`(${this.where}) && (${e.join(" || ")})`:e.join(" || ")},_getParentNameByField(){const e=this.field.split(",");let t=null;for(let a=0;a<e.length;a++){const i=e[a].split("as");if(!(i.length<2)&&"value"===i[1].trim()){t=i[0].trim();break}}return t},_isTreeView(){return this.parentField&&this.selfField},_updateSelected(){var e=this.dataList,t=this.selected;let a=this.map.text,i=this.map.value;for(var l=0;l<t.length;l++)for(var s=t[l].value,r=e[l],h=0;h<r.length;h++){var n=r[h];if(n[i]===s){t[l].text=n[a];break}}},_updateBindData(e){const{dataList:t,hasNodes:a}=this._filterData(this._treeData,this.selected);let i=!1===this._stepSearh&&!a;return e&&(e.isleaf=i),this.dataList=t,this.selectedIndex=t.length-1,!i&&this.selected.length<t.length&&this.selected.push({value:null,text:"请选择"}),{isleaf:i,hasNodes:a}},_filterData(e,t){let a=[],i=!0;a.push(e.filter((e=>null===e.parent_value||void 0===e.parent_value||""===e.parent_value)));for(let r=0;r<t.length;r++){var l=t[r].value,s=e.filter((e=>e.parent_value===l));s.length?a.push(s):i=!1}return{dataList:a,hasNodes:i}},_extractTree(e,t,a){let i=this.map.value;for(let l=0;l<e.length;l++){let s=e[l],r={};for(let e in s)"children"!==e&&(r[e]=s[e]);null!=a&&""!==a&&(r.parent_value=a),t.push(r);let h=s.children;h&&this._extractTree(h,t,s[i])}},_extractTreePath(e,t){for(let a=0;a<e.length;a++){let i=e[a],l={};for(let e in i)"children"!==e&&(l[e]=i[e]);t.push(l);let s=i.children;s&&this._extractTreePath(s,t)}},_findNodePath(e,t,a=[]){let i=this.map.text,l=this.map.value;for(let s=0;s<t.length;s++){let r=t[s],h=r.children,n=r[i],d=r[l];if(a.push({value:d,text:n}),d===e)return a;if(h){const t=this._findNodePath(e,h,a);if(t.length)return t}a.pop()}return[]},_processLocalData(){this._treeData=[],this._extractTree(this.localdata,this._treeData);var e=this.dataValue;void 0!==e&&(Array.isArray(e)&&"object"==typeof(e=e[e.length-1])&&e[this.map.value]&&(e=e[this.map.value]),this.selected=this._findNodePath(e,this.localdata))}}};exports.dataPicker=t;
