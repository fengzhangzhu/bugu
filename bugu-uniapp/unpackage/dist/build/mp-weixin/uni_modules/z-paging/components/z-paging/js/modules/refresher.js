"use strict";var e=require("../z-paging-utils.js"),r=require("../z-paging-constant.js"),t=require("../z-paging-enum.js");const s={props:{refresherThemeStyle:{type:String,default:function(){return e.u.gc("refresherThemeStyle","")}},refresherImgStyle:{type:Object,default:function(){return e.u.gc("refresherImgStyle",{})}},refresherTitleStyle:{type:Object,default:function(){return e.u.gc("refresherTitleStyle",{})}},refresherUpdateTimeStyle:{type:Object,default:function(){return e.u.gc("refresherUpdateTimeStyle",{})}},watchRefresherTouchmove:{type:Boolean,default:e.u.gc("watchRefresherTouchmove",!1)},loadingMoreThemeStyle:{type:String,default:function(){return e.u.gc("loadingMoreThemeStyle","")}},refresherOnly:{type:Boolean,default:e.u.gc("refresherOnly",!1)},refresherDefaultDuration:{type:[Number,String],default:e.u.gc("refresherDefaultDuration",100)},refresherCompleteDelay:{type:[Number,String],default:e.u.gc("refresherCompleteDelay",0)},refresherCompleteDuration:{type:[Number,String],default:e.u.gc("refresherCompleteDuration",300)},refresherCompleteScrollable:{type:Boolean,default:e.u.gc("refresherCompleteScrollable",!1)},useCustomRefresher:{type:Boolean,default:e.u.gc("useCustomRefresher",!0)},refresherFps:{type:[Number,String],default:e.u.gc("refresherFps",40)},refresherMaxAngle:{type:[Number,String],default:e.u.gc("refresherMaxAngle",40)},refresherAngleEnableChangeContinued:{type:Boolean,default:e.u.gc("refresherAngleEnableChangeContinued",!1)},refresherDefaultText:{type:[String,Object],default:e.u.gc("refresherDefaultText",null)},refresherPullingText:{type:[String,Object],default:e.u.gc("refresherPullingText",null)},refresherRefreshingText:{type:[String,Object],default:e.u.gc("refresherRefreshingText",null)},refresherCompleteText:{type:[String,Object],default:e.u.gc("refresherCompleteText",null)},refresherEndBounceEnabled:{type:Boolean,default:e.u.gc("refresherEndBounceEnabled",!0)},refresherEnabled:{type:Boolean,default:e.u.gc("refresherEnabled",!0)},refresherThreshold:{type:[Number,String],default:e.u.gc("refresherThreshold","80rpx")},refresherDefaultStyle:{type:String,default:e.u.gc("refresherDefaultStyle","black")},refresherBackground:{type:String,default:e.u.gc("refresherBackground","transparent")},refresherFixedBackground:{type:String,default:e.u.gc("refresherFixedBackground","transparent")},refresherFixedBacHeight:{type:[Number,String],default:e.u.gc("refresherFixedBacHeight",0)},refresherOutRate:{type:Number,default:e.u.gc("refresherOutRate",.7)},showRefresherUpdateTime:{type:Boolean,default:e.u.gc("showRefresherUpdateTime",!1)},refresherUpdateTimeKey:{type:String,default:e.u.gc("refresherUpdateTimeKey","default")}},data:()=>({refresherStatus:t.Enum.Refresher.Default,refresherTouchstartY:0,lastRefresherTouchmove:null,refresherReachMaxAngle:!0,refresherTransform:"translateY(0px)",refresherTransition:"",finalRefresherDefaultStyle:"black",refresherRevealStackCount:0,refresherCompleteTimeout:null,refresherCompleteSubTimeout:null,refresherEndTimeout:null,isTouchmovingTimeout:null,refresherTriggered:!1,isTouchmoving:!1,isTouchEnded:!1,isUserPullDown:!1,privateRefresherEnabled:-1,privateShowRefresherWhenReload:!1,customRefresherHeight:-1,showCustomRefresher:!1,doRefreshAnimateAfter:!1,isRefresherInComplete:!1,pullDownTimeStamp:0,moveDis:0,oldMoveDis:0,oldRefresherTouchmoveY:0,oldTouchDirection:""}),watch:{refresherDefaultStyle:{handler(e){e.length&&(this.finalRefresherDefaultStyle=e)},immediate:!0},refresherStatus(e,r){e===t.Enum.Refresher.Loading&&this._cleanRefresherEndTimeout(),this.$emit("refresherStatusChange",e),this.$emit("update:refresherStatus",e)},moveDis(e,r){this.oldMoveDis=r}},computed:{pullDownDisTimeStamp(){return 1e3/this.refresherFps},finalRefresherEnabled(){return!this.useChatRecordMode&&(-1===this.privateRefresherEnabled?this.refresherEnabled:1===this.privateRefresherEnabled)},finalRefresherThreshold(){let r=this.refresherThreshold,t=!1;return"80rpx"===r&&(t=!0,this.showRefresherUpdateTime&&(r="120rpx")),t&&this.customRefresherHeight>0?this.customRefresherHeight:e.u.convertTextToPx(r)},finalRefresherFixedBacHeight(){return e.u.convertTextToPx(this.refresherFixedBacHeight)},finalRefresherThemeStyle(){return this.refresherThemeStyle.length?this.refresherThemeStyle:this.defaultThemeStyle},finalRefresherOutRate(){let e=this.refresherOutRate;return e=Math.max(0,e),e=Math.min(1,e),e},finalRefresherTransform(){return"translateY(0px)"===this.refresherTransform?"none":this.refresherTransform},finalShowRefresherWhenReload(){return this.showRefresherWhenReload||this.privateShowRefresherWhenReload},finalRefresherTriggered(){return!(!this.finalRefresherEnabled||this.useCustomRefresher)&&this.refresherTriggered},showRefresher(){const e=this.finalRefresherEnabled&&this.useCustomRefresher&&this.isTouchmoving;return-1===this.customRefresherHeight&&e&&setTimeout((()=>{this.$nextTick((()=>{this._updateCustomRefresherHeight()}))}),100),e},hasTouchmove(){return this.watchRefresherTouchmove}},methods:{endRefresh(){this._refresherEnd()},handleRefresherStatusChanged(e){this.refresherStatusChangedFunc=e},_onRefresh(e=!1,r=!0){(!e||this.finalRefresherEnabled&&!this.useCustomRefresher)&&(this.$emit("onRefresh"),this.$emit("Refresh"),this.loading||this.isRefresherInComplete||(this.loadingType=t.Enum.LoadingType.Refresher,this.nShowRefresherReveal||(this.isUserPullDown=r,this.isUserReload=!r,this._startLoading(!0),this.refresherTriggered=!0,this.reloadWhenRefresh&&r&&(this.useChatRecordMode?this._onLoadingMore("click"):this._reload(!1,!1,r)))))},_onRestore(){this.refresherTriggered="restore",this.$emit("onRestore"),this.$emit("Restore")},_handleRefresherTouchstart(e){!this.loading&&this.isTouchEnded&&(this.isTouchmoving=!1),this.isTouchmovingTimeout&&clearTimeout(this.isTouchmovingTimeout),this.isTouchEnded=!1,this.refresherTransition="",this.refresherTouchstartY=e.touchY,this.$emit("refresherTouchstart",this.refresherTouchstartY),this.lastRefresherTouchmove=e,this._cleanRefresherCompleteTimeout(),this._cleanRefresherEndTimeout()},_handleRefresherTouchmove(e,r){this.refresherReachMaxAngle=!0,this.isTouchmovingTimeout&&clearTimeout(this.isTouchmovingTimeout),this.isTouchmoving=!0,this.isTouchEnded=!1,this.refresherStatus=e>=this.finalRefresherThreshold?t.Enum.Refresher.ReleaseToRefresh:this.refresherStatus=t.Enum.Refresher.Default,this.moveDis=e},_handleRefresherTouchend(r){this.isTouchmovingTimeout&&clearTimeout(this.isTouchmovingTimeout),this.refresherReachMaxAngle=!0,r<0&&this.usePageScroll&&this.loadingMoreEnabled&&this.useCustomRefresher&&-1===this.pageScrollTop&&this.showConsoleError&&e.u.consoleErr("usePageScroll为true并且自定义下拉刷新时必须引入mixin或在page滚动时通过调用z-paging组件的updatePageScrollTop方法设置当前的scrollTop"),this.isTouchEnded=!0,r>=this.finalRefresherThreshold&&this.refresherStatus===t.Enum.Refresher.ReleaseToRefresh?(this.moveDis=this.finalRefresherThreshold,this.refresherStatus=t.Enum.Refresher.Loading,this._doRefresherLoad()):(this._refresherEnd(),this.isTouchmovingTimeout=setTimeout((()=>{this.isTouchmoving=!1}),this.refresherDefaultDuration)),this.scrollEnable=!0,this.$emit("refresherTouchend",r)},_handleScrollViewDisableBounce(e){this.usePageScroll||this.scrollToTopBounceEnabled||(this.refresherTransition="",this.scrollEnable=e.bounce)},_handleWxsPullingDownStatusChange(e){this.wxsOnPullingDown=e,e&&!this.useChatRecordMode&&(this.renderPropScrollTop=0)},_handleWxsPullingDown(e){this._emitTouchmove({pullingDistance:e.moveDis,dy:e.diffDis})},_handleTouchDirectionChange(e){this.$emit("touchDirectionChange",e.direction)},_handlePropUpdate(r){this.wxsPropType=e.u.getTime().toString()},_refresherEnd(s=!0,h=!1,i=!1,o=!0){if(this.loadingType===t.Enum.LoadingType.Refresher){let r=0;h&&(i||this.showRefresherWhenReload)&&(r=this.refresherCompleteDuration>700?1:this.refresherCompleteDelay);const s=r>0?t.Enum.Refresher.Complete:t.Enum.Refresher.Default;if(this.finalShowRefresherWhenReload){const e=this.refresherRevealStackCount;if(this.refresherRevealStackCount--,e>1)return}this._cleanRefresherEndTimeout(),this.refresherEndTimeout=setTimeout((()=>{this.refresherStatus=s}),this.refresherStatus!==t.Enum.Refresher.Default&&s===t.Enum.Refresher.Default?this.refresherCompleteDuration:0),r>0&&(this.isRefresherInComplete=!0),this._cleanRefresherCompleteTimeout(),this.refresherCompleteTimeout=setTimeout((()=>{let r=1;const i=this.refresherEndBounceEnabled&&h?"cubic-bezier(0.19,1.64,0.42,0.72)":"linear";h&&(r=this.refresherEndBounceEnabled?this.refresherCompleteDuration/1e3:this.refresherCompleteDuration/3e3),this.refresherTransition=`transform ${h?r:this.refresherDefaultDuration/1e3}s ${i}`,this.wxsPropType=this.refresherTransition+"end"+e.u.getTime(),this.moveDis=0,s===t.Enum.Refresher.Complete&&(this.refresherCompleteSubTimeout&&(clearTimeout(this.refresherCompleteSubTimeout),this.refresherCompleteSubTimeout=null),this.refresherCompleteSubTimeout=setTimeout((()=>{this.$nextTick((()=>{this.refresherStatus=t.Enum.Refresher.Default,this.isRefresherInComplete=!1}))}),800*r))}),r)}o&&(setTimeout((()=>{this.loading=!1}),s?r.c.delayTime:0),i&&this._onRestore())},_doRefresherRefreshAnimate(){this._cleanRefresherCompleteTimeout();!this.doRefreshAnimateAfter&&this.finalShowRefresherWhenReload&&-1===this.customRefresherHeight&&"80rpx"===this.refresherThreshold?this.doRefreshAnimateAfter=!0:(this.refresherRevealStackCount++,this.wxsPropType="begin"+e.u.getTime(),this.moveDis=this.finalRefresherThreshold,this.refresherStatus=t.Enum.Refresher.Loading,this.isTouchmoving=!0,this.isTouchmovingTimeout&&clearTimeout(this.isTouchmovingTimeout),this._doRefresherLoad(!1))},_doRefresherLoad(e=!0){this._onRefresh(!1,e),this.loading=!0},_getFinalRefresherMoveDis(e){return(e*=.85)>=this.finalRefresherThreshold&&(e=this.finalRefresherThreshold+(e-this.finalRefresherThreshold)*(1-this.finalRefresherOutRate)),e},_updateCustomRefresherHeight(){this._getNodeClientRect(".zp-custom-refresher-slot-view").then((e=>{e?(this.customRefresherHeight=e[0].height,this.customRefresherHeight>0&&(this.showCustomRefresher=!0)):this.customRefresherHeight=0,this.doRefreshAnimateAfter&&(this.doRefreshAnimateAfter=!1,this._doRefresherRefreshAnimate())}))},_emitTouchmove(e){e.viewHeight=this.finalRefresherThreshold,e.rate=e.pullingDistance/e.viewHeight,this.hasTouchmove&&this.$emit("refresherTouchmove",e)},_cleanRefresherCompleteTimeout(){this.refresherCompleteTimeout=this._cleanTimeout(this.refresherCompleteTimeout)},_cleanRefresherEndTimeout(){this.refresherEndTimeout=this._cleanTimeout(this.refresherEndTimeout)}}};exports.ZPRefresher=s;
