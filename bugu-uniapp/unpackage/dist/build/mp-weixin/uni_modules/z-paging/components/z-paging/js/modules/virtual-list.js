"use strict";var t=require("../z-paging-utils.js"),e=require("../z-paging-constant.js"),i=require("../z-paging-enum.js");const l={props:{useVirtualList:{type:Boolean,default:t.u.gc("useVirtualList",!1)},useInnerList:{type:Boolean,default:t.u.gc("useInnerList",!1)},forceCloseInnerList:{type:Boolean,default:t.u.gc("forceCloseInnerList",!1)},cellKeyName:{type:String,default:t.u.gc("cellKeyName","")},innerListStyle:{type:Object,default:function(){return t.u.gc("innerListStyle",{})}},innerCellStyle:{type:Object,default:function(){return t.u.gc("innerCellStyle",{})}},preloadPage:{type:[Number,String],default:t.u.gc("preloadPage",7),validator:e=>(e<=0&&t.u.consoleErr("preload-page必须大于0！"),e>0)},cellHeightMode:{type:String,default:t.u.gc("cellHeightMode","fixed")},virtualListCol:{type:[Number,String],default:t.u.gc("virtualListCol",1)},virtualScrollFps:{type:[Number,String],default:t.u.gc("virtualScrollFps",60)}},data:()=>({virtualListKey:t.u.getInstanceId(),virtualPageHeight:0,virtualCellHeight:0,virtualScrollTimeStamp:0,virtualList:[],virtualPlaceholderTopHeight:0,virtualPlaceholderBottomHeight:0,virtualTopRangeIndex:0,virtualBottomRangeIndex:0,lastVirtualTopRangeIndex:0,lastVirtualBottomRangeIndex:0,virtualHeightCacheList:[],getCellHeightRetryCount:{fixed:0,dynamic:0},pagingOrgTop:-1,updateVirtualListFromDataChange:!1}),watch:{realTotalData(t){this.finalUseVirtualList&&(this.updateVirtualListFromDataChange=!0,this.$nextTick((()=>{t.length||this._resetDynamicListState(!this.isUserPullDown),this.getCellHeightRetryCount.fixed=0,this.finalUseVirtualList&&t.length&&this.cellHeightMode===i.Enum.CellHeightMode.Fixed&&this.isFirstPage&&this._updateFixedCellHeight(),this.finalUseVirtualList&&this._updateVirtualScroll(this.oldScrollTop)})))},virtualList(t){this.$emit("update:virtualList",t),this.$emit("virtualListChange",t)}},computed:{finalUseVirtualList(){return this.useVirtualList&&this.usePageScroll&&t.u.consoleErr("使用页面滚动时，开启虚拟列表无效！"),this.useVirtualList&&!this.usePageScroll},finalUseInnerList(){return this.useInnerList||this.finalUseVirtualList&&!this.forceCloseInnerList},finalCellKeyName(){return this.cellKeyName},finalVirtualPageHeight(){return this.virtualPageHeight>0?this.virtualPageHeight:this.windowHeight},virtualRangePageHeight(){return this.finalVirtualPageHeight*this.preloadPage},virtualScrollDisTimeStamp(){return 1e3/this.virtualScrollFps}},methods:{_virtualListInit(){this.$nextTick((()=>{setTimeout((()=>{this._getNodeClientRect(".zp-scroll-view").then((t=>{t&&t.length&&(this.pagingOrgTop=t[0].top,this.virtualPageHeight=t[0].height)}))}),e.c.delayTime)}))},_updateFixedCellHeight(){this.$nextTick((()=>{const i=setTimeout((()=>{this._getNodeClientRect("#zp-0",this.finalUseInnerList).then((e=>{if(e&&e.length)this.virtualCellHeight=e[0].height,this._updateVirtualScroll(this.oldScrollTop);else{if(clearTimeout(i),this.getCellHeightRetryCount.fixed>10)return void t.u.consoleErr('获取虚拟列表cell高度失败，可能是for循环cell处没有写:id="`zp-${item.zp_index}`"，请检查您的代码！');this.getCellHeightRetryCount.fixed++,this._updateFixedCellHeight()}}))}),e.c.delayTime)}))},_updateDynamicCellHeight(i){this.$nextTick((()=>{const l=setTimeout((async()=>{for(let a=0;a<i.length;a++){let s=i[a];const h=await this._getNodeClientRect(`#zp-${s[e.c.listCellIndexKey]}`,this.finalUseInnerList),r=h&&h.length,n=r?h[0].height:0;if(!r){if(clearTimeout(l),this.virtualHeightCacheList=this.virtualHeightCacheList.slice(-a),this.getCellHeightRetryCount.dynamic>10)return void t.u.consoleErr('获取虚拟列表cell高度失败，可能是for循环cell处没有写:id="`zp-${item.zp_index}`"，请检查您的代码！');this.getCellHeightRetryCount.dynamic++,this._updateDynamicCellHeight(i);break}let o=null;this.virtualHeightCacheList.length&&(o=this.virtualHeightCacheList.slice(-1)[0]);const u=o?o.totalHeight:0;this.virtualHeightCacheList.push({height:n,lastHeight:u,totalHeight:u+n})}this._updateVirtualScroll(this.oldScrollTop)}),e.c.delayTime)}))},_setCellIndex(t,l){let a=null,s=0;l?this._resetDynamicListState():(s=this.realTotalData.length,this.realTotalData.length&&(a=this.realTotalData.slice(-1)[0]),a&&void 0!==a[e.c.listCellIndexKey]&&(s=a[e.c.listCellIndexKey]+1));for(let i=0;i<t.length;i++){let l=t[i];l&&"[object Object]"===Object.prototype.toString.call(l)||(l={item:l}),l[e.c.listCellIndexKey]=s+i,l[e.c.listCellIndexUniqueKey]=`${this.virtualListKey}-${l[e.c.listCellIndexKey]}`,t[i]=l}this.getCellHeightRetryCount.dynamic=0,this.cellHeightMode===i.Enum.CellHeightMode.Dynamic&&this._updateDynamicCellHeight(t)},_updateVirtualScroll(e,l=0){const a=t.u.getTime();if(0===e&&this._resetTopRange(),0!==e&&this.virtualScrollTimeStamp&&a-this.virtualScrollTimeStamp<=this.virtualScrollDisTimeStamp)return;this.virtualScrollTimeStamp=Number(a);let s=0;const h=this.cellHeightMode;if(h===i.Enum.CellHeightMode.Fixed)s=parseInt(e/this.virtualCellHeight)||0,this._updateFixedTopRangeIndex(s),this._updateFixedBottomRangeIndex(s);else if(h===i.Enum.CellHeightMode.Dynamic){const t=l>0?"top":"bottom",i=this.virtualRangePageHeight,a=e-i,s=e+this.finalVirtualPageHeight+i;let h=0,r=0,n=!1,o=null;const u=this.virtualHeightCacheList;u.length&&(o=u.slice(-1)[0]);let g=this.virtualTopRangeIndex;if("bottom"===t)for(let e=g;e<u.length;e++){const t=u[e];if(t&&t.totalHeight>a){this.virtualTopRangeIndex=e,this.virtualPlaceholderTopHeight=t.lastHeight;break}}else{let t=!1;for(let e=g;e>=0;e--){const i=u[e];if(i&&i.totalHeight<a){this.virtualTopRangeIndex=e,this.virtualPlaceholderTopHeight=i.lastHeight,t=!0;break}}!t&&this._resetTopRange()}for(let e=this.virtualTopRangeIndex;e<u.length;e++){const t=u[e];if(t&&t.totalHeight>s){h=e,r=o.totalHeight-t.totalHeight,n=!0;break}}n&&0!==this.virtualBottomRangeIndex?(this.virtualBottomRangeIndex=h,this.virtualPlaceholderBottomHeight=r):(this.virtualBottomRangeIndex=this.realTotalData.length?this.realTotalData.length-1:this.pageSize,this.virtualPlaceholderBottomHeight=0),this._updateVirtualList()}},_updateFixedTopRangeIndex(t){let e=0===this.virtualCellHeight?0:t-parseInt(this.finalVirtualPageHeight/this.virtualCellHeight)*this.preloadPage;e*=this.virtualListCol,e=Math.max(0,e),this.virtualTopRangeIndex=e,this.virtualPlaceholderTopHeight=e/this.virtualListCol*this.virtualCellHeight},_updateFixedBottomRangeIndex(t){let e=0===this.virtualCellHeight?this.pageSize:t+parseInt(this.finalVirtualPageHeight/this.virtualCellHeight)*(this.preloadPage+1);e*=this.virtualListCol,e=Math.min(this.realTotalData.length,e),this.virtualBottomRangeIndex=e,this.virtualPlaceholderBottomHeight=(this.realTotalData.length-e)*this.virtualCellHeight/this.virtualListCol,this._updateVirtualList()},_updateVirtualList(){(this.updateVirtualListFromDataChange||this.lastVirtualTopRangeIndex!==this.virtualTopRangeIndex||this.lastVirtualBottomRangeIndex!==this.virtualBottomRangeIndex)&&(this.updateVirtualListFromDataChange=!1,this.lastVirtualTopRangeIndex=this.virtualTopRangeIndex,this.lastVirtualBottomRangeIndex=this.virtualBottomRangeIndex,this.virtualList=this.realTotalData.slice(this.virtualTopRangeIndex,this.virtualBottomRangeIndex+1))},_resetDynamicListState(t=!1){this.virtualHeightCacheList=[],t&&(this.virtualList=[]),this.virtualTopRangeIndex=0,this.virtualPlaceholderTopHeight=0},_resetTopRange(){this.virtualTopRangeIndex=0,this.virtualPlaceholderTopHeight=0,this._updateVirtualList()},_checkVirtualListScroll(){this.finalUseVirtualList&&this.$nextTick((()=>{this._getNodeClientRect(".zp-paging-touch-view").then((t=>{const e=t&&t.length,i=e?t[0].top:0;(!e||i===this.pagingOrgTop&&0!==this.virtualPlaceholderTopHeight)&&this._updateVirtualScroll(0)}))}))}}};exports.ZPVirtualList=l;
