"use strict";var e=require("../../common/vendor.js"),t=require("../../utils/messageUtils/index.js"),i=require("../../utils/messageUtils/storage.js"),s=require("../../common/storageFunctions.js"),a=require("../../common/constants.js"),n=require("../../store/index.js"),o=require("../../utils/socket.js"),r=require("../../common/storageKeys.js"),c=require("../../utils/request.js"),l=require("../../utils/tabBarBadgeUtils.js"),d=require("../../common/requestFunctions.js");require("../../utils/messageUtils/service.js"),require("../../utils/messageUtils/storageKeys.js"),require("../../utils/dateUtils.js"),require("../../store/modules/messageStore.js"),require("../../store/modules/socketStateStore.js"),require("../../common/globalMsgKeys.js");const u={data:()=>({tabLabels:[{title:"消息",badge:0},{title:"动态",badge:0}],tabSelect:0,InteractiveGroup:a.InteractiveGroup,InteractiveType:a.InteractiveType,OfficeMessageType:a.OfficeMessageType,scrollInto:"",userMessageList:[],officialNewsList:[],attentionUnreadSum:0,likedUnreadSum:0,commentUnreadSum:0,publishUnreadSum:0,questionMessageUnreadSum:0,state:n.store.state,userInfo:{},editArticleItem:{},refresherEnabled:!1,editUserMessageItem:{},editOfficialNewsItem:{},attentionArticles:{data:[],isRefresh:!1,haveMoreData:!0,page:1},contentHeight:0,navHeight:0}),async onLoad(){this.userInfo=await s.getMyUserInfo(),this.userInfo&&(this.refreshMessages(this.userInfo),this.officialNewsList=await i.getOfficalList(this.userInfo.id))},onReady(){let t=this;e.index.getSystemInfo({success(e){t.contentHeight=e.windowHeight}}),e.index.createSelectorQuery().select("#message-swiper").boundingClientRect((e=>{t.navHeight=e.top})).exec()},async onShow(){if(l.changeUnreadMessageSum(),this.userInfo=await s.getMyUserInfo(),!this.userInfo)return this.tabLabels=[{title:"动态",badge:0},{title:"消息",badge:0}],this.userMessageList=[],this.interactiveMessageList={unreadSum:0,data:[]},this.likedUnreadSum=0,this.commentUnreadSum=0,void(this.publishUnreadSum=0);this.refreshMessages(this.userInfo),this.state.socketStateStore.isConnectSocket||o.connectSocket()},computed:{newMessage(){return this.state.messageStore.newMessage},statusBarHeight:()=>e.index.getSystemInfoSync().statusBarHeight+"px",scollerHeight(){return this.contentHeight-this.navHeight}},watch:{newMessage:async function(e){if(e.type===a.USER_MESSAGE||e.type===a.WITHDRAW){let e=await i.getUserMessageList(this.userInfo.id);this.userMessageList=e.reverse()}else if(e.type===a.INTERACTIVE){let t=await i.getInteractiveMessageList(this.userInfo.id,e.data.type);-1!=i.likeGroup.indexOf(e.data.type)?this.likedUnreadSum=t.unreadSum:-1!=i.commentGroup.indexOf(e.data.type)?this.commentUnreadSum=t.unreadSum:e.data.type===a.InteractiveType.PUBLISH?this.tabLabels[0].badge=t.unreadSum:e.data.type===a.InteractiveType.ATTENTION&&(this.attentionUnreadSum=t.unreadSum)}}},onShareAppMessage(){let e="";this.editArticleItem.pic.length>0&&(e=1==this.editArticleItem.video?this.editArticleItem.pic[0]+"?vframe/jpg/offset/0":this.editArticleItem.pic[0]);let t="";return 1==this.editArticleItem.isAnonymity?t="匿名用户":this.editArticleItem.publisher&&(t=this.editArticleItem.publisher.username),{title:`${t}发布了一条动态，快来看看ta说了什么`,path:`/pages/activity-info/activity-info?activityId=${this.editArticleItem.id}`,imageUrl:e}},methods:{async refreshMessages(e){let s=await i.getUserMessageList(this.userInfo.id);this.userMessageList=s.reverse(),this.attentionUnreadSum=(await i.getInteractiveMessageList(this.userInfo.id,a.InteractiveType.ATTENTION)).unreadSum,this.likedUnreadSum=(await i.getInteractiveMessageList(this.userInfo.id,a.InteractiveType.LIKE)).unreadSum,this.commentUnreadSum=(await i.getInteractiveMessageList(this.userInfo.id,a.InteractiveType.COMMENT)).unreadSum,this.tabLabels[0].badge=(await i.getInteractiveMessageList(this.userInfo.id,a.InteractiveType.PUBLISH)).unreadSum;let n=await t.getAndHandOfficialNewsList(this.userInfo.id);this.officialNewsList=n.reverse()},onTabsClick(e){this.tabSelect=e},async onSwiperChange(e){this.tabSelect=e.detail.current,1==this.tabSelect&&this.tabLabels[1].badge>0&&(l.changeUnreadMessageSum(-this.tabLabels[1].badge),this.tabLabels[1].badge=0,this.userInfo.id&&i.interactiveMessageALLRead(this.userInfo.id,a.InteractiveType.PUBLISH))},onSwiperTransition(){this.attentionArticles.isRefresh||(this.refresherEnabled=!1)},onSwiperAnimationfinish(){this.refresherEnabled=!0,1==this.tabSelect&&this.attentionArticles.data.length<1&&this.attentionArticles.haveMoreData&&(this.attentionArticles.isRefresh=!0)},onAttentionIsRefresh(){this.attentionArticles.isRefresh=!0,this.attentionArticles.page=1,this.getAttentionarticles(this.attentionArticles.page)},onAttentionScrolltolower(){this.attentionArticles.haveMoreData&&(this.showBottomLoading=!0,this.attentionArticles.page=this.attentionArticles.page+1,this.getAttentionarticles(this.attentionArticles.page))},onActivityItemClick(t){e.index.navigateTo({url:`/pages/activity-info/activity-info?activityId=${t.id}`})},onMoreClick(e){this.$refs.articleActionPopup.open(),this.editArticleItem=e},onShareClick(e){this.editArticleItem=e},onPopupReportClick(t){e.index.navigateTo({url:`/pages/setting/report-user/report-user?objectId=${t.id}&objectType=${a.reportObjectType.activity}`}),this.$refs.articleActionPopup.close()},async onCancelFollow(t){if(!t.publisher)return;let i=this;e.index.showModal({title:"取消关注",content:`你确定要取消关注${t.publisher.username}`,success:async function(s){if(s.confirm&&t.publisher&&await d.cancelAttention(t.publisher.id)){let s=i.attentionArticles.data;for(let e=0;e<s.length;e++)s[e].publisher&&s[e].publisher.id==t.publisher.id&&(s[e].publisher.isAttention=0);i.attentionArticles.data=s,i.$refs.articleActionPopup.close(),e.index.showToast({title:"取消关注",icon:"success"})}}})},async onFollow(t){if(!t.publisher)return;let i=this;if(await d.followUser(t.publisher.id)){let s=i.attentionArticles.data;for(let e=0;e<s.length;e++)s[e].publisher&&s[e].publisher.id==t.publisher.id&&(s[e].publisher.isAttention=1);i.attentionArticles.data=s,i.$refs.articleActionPopup.close(),e.index.showToast({title:"关注成功",icon:"success"})}},async onChatClick(t){t.publisher&&e.index.navigateTo({url:`/pages/message-secondary-page/chat-content/chat-content?fromUserId=${t.publisher.id}`})},onSearchBarClick(){e.index.navigateTo({url:"/pages/message-secondary-page/search-user/search-user"})},onInteractiveMessageClick(t){e.index.navigateTo({url:"/pages/message-secondary-page/interactive-message/interactive-message?type="+t})},onQuestionMessageClick(){e.index.navigateTo({url:"/pages/message-secondary-page/question-message/question-message"})},onUserMessageItemClick(t){e.index.navigateTo({url:`/pages/message-secondary-page/chat-content/chat-content?fromUserId=${t.userId}`})},onUserMessageMoreClick(e){this.editUserMessageItem=e,this.$refs.userMessageActionPopup.open()},onUserMessageDeleteClick(t){let s=this;e.index.showModal({title:"删除对话",content:`你确定要删除与${t.username}的对话吗？`,success:async function(e){if(e.confirm){if(t){l.changeUnreadMessageSum(-t.unReadSum);let e=await i.deleteUserMessageItem(s.userInfo.id,t.userId);s.userMessageList=e}s.$refs.userMessageActionPopup.close()}}})},onUserMessageReportClick(t){this.$refs.userMessageActionPopup.close(),e.index.navigateTo({url:`/pages/setting/report-user/report-user?objectId=${t.userId}&objectType=chat`})},onOfficialNewsItemMoreClick(e){this.editOfficialNewsItem=e,this.$refs.officialNewsActionPopup.open()},onOfficialNewsDeleteClick(t){let s=this;e.index.showModal({title:"删除对话",content:"你确定要删除这个消息记录吗？",success:async function(e){if(e.confirm){if(t){l.changeUnreadMessageSum(-t.unreadSum);let e=await i.deleteOfficalNewsItem(s.userInfo.id,t.type);s.officialNewsList=e}s.$refs.officialNewsActionPopup.close()}}})},onOfficialNewsItemClick(t){e.index.navigateTo({url:`/pages/message-secondary-page/official-news-info/official-news-info?type=${t.type}`})},async getAttentionarticles(t,i=!1){let s=await c.request({data:{method:"GET",group:"activity",action:"attention",data:{page:t},header:{"content-type":"application/x-www-form-urlencoded"}}});if(setTimeout((()=>{this.attentionArticles.isRefresh=!1}),700),this.showBottomLoading=!1,s.data.code===a.REQUEST_SUCCEEDED_CODE){let a=s.data.data.pageSum,n=s.data.data.list;if(1===t)e.index.showToast({title:"刷新成功",icon:"none"}),i||this.playRefreshDynamicSound(),this.attentionArticles.data=n,this.scrollInto="",this.attentionArticles.haveMoreData=!(a<=1);else if(t>a)this.attentionArticles.haveMoreData=!1,this.attentionArticles.page=t-1;else{let e=this.attentionArticles.data.concat(n);this.attentionArticles.data=e,this.attentionArticles.haveMoreData=t!=a}n.length<1&&t<a&&(this.attentionArticles.page=t+1,this.getAttentionarticles(this.attentionArticles.page,!0))}},async playRefreshDynamicSound(){let t=e.index.getStorageSync(r.REFRESH_DYNAMIC_SOUND);t||(t=a.RingingToneList[6]);const i=e.index.createInnerAudioContext();i.autoplay=!0,i.src=t.url}}};if(!Array){(e.resolveComponent("page-tabs")+e.resolveComponent("interactive-message")+e.resolveComponent("user-message-item")+e.resolveComponent("activity-item")+e.resolveComponent("uni-load-more")+e.resolveComponent("action-sheet-item")+e.resolveComponent("action-sheet"))()}Math||((()=>"../../components/page-tabs/page-tabs.js")+(()=>"../../components/interactive-message/interactive-message.js")+(()=>"../../components/user-message-item/user-message-item.js")+(()=>"../../components/activity-item/activity-item.js")+(()=>"../../uni_modules/uni-load-more/components/uni-load-more/uni-load-more.js")+(()=>"../../components/action-sheet-item/action-sheet-item.js")+(()=>"../../components/action-sheet/action-sheet.js"))();var g=e._export_sfc(u,[["render",function(t,i,s,a,n,o){return e.e({a:e.o(o.onTabsClick),b:e.p({labels:n.tabLabels,index:n.tabSelect,tabPadding:26,activeFontSize:18,defaultFontSize:16,flex:!0,defaultColor:"#7a7a7a",underLineType:"bubble"}),c:o.statusBarHeight,d:e.o((e=>o.onSearchBarClick())),e:e.o((e=>o.onInteractiveMessageClick("ATTENTION"))),f:e.p({avatar:"/static/svgs/add_user.svg",title:"关注",badgeNumber:n.attentionUnreadSum}),g:e.o((e=>o.onInteractiveMessageClick("COMMENT"))),h:e.p({avatar:"/static/svgs/message-comment.svg",title:"评论和回答",badgeNumber:n.commentUnreadSum}),i:e.o((e=>o.onInteractiveMessageClick("LIKE"))),j:e.p({avatar:"/static/svgs/message-like.svg",title:"喜欢和赞同",badgeNumber:n.likedUnreadSum}),k:n.officialNewsList.length>0},n.officialNewsList.length>0?{l:e.f(n.officialNewsList,((t,i,s)=>({a:t.type,b:e.o((e=>o.onOfficialNewsItemClick(t)),t.type),c:e.o((e=>o.onOfficialNewsItemMoreClick(t)),t.type),d:"403d4490-4-"+s,e:e.p({avatar:t.type===n.OfficeMessageType.ACTIVITY?"/static/svgs/official-activities.svg":"/static/svgs/official-communication.svg",title:"布咕通知",messageType:"official",badgeNumber:t.unreadSum,note:t.lastText,needOnlineState:!1,time:t.lastTime})})))}:{},{m:n.userMessageList.length>0},n.userMessageList.length>0?{n:e.f(n.userMessageList,((t,i,s)=>({a:t.userId,b:e.o((e=>o.onUserMessageItemClick(t)),t.userId),c:e.o((e=>o.onUserMessageMoreClick(t)),t.userId),d:"403d4490-5-"+s,e:e.p({avatar:t.avatar,title:t.username,note:1==t.lastMessageType?"[图片]":2==t.lastMessageType?"语音":t.lastMessage,needOnlineState:!0,time:t.lastTime,onLineState:t.online,badgeNumber:t.unReadSum})})))}:{},{o:o.scollerHeight+"px",p:e.f(n.attentionArticles.data,((t,i,s)=>({a:t.id,b:e.o((e=>o.onFollow(t)),t.id),c:e.o((e=>o.onMoreClick(t)),t.id),d:e.o((e=>o.onActivityItemClick(t)),t.id),e:e.o((e=>o.onShareClick(t)),t.id),f:"403d4490-6-"+s,g:e.p({articleItem:t,isMe:!1})}))),q:n.attentionArticles.data.length>0},n.attentionArticles.data.length>0?{r:e.p({iconType:"circle",status:n.attentionArticles.haveMoreData?t.showBottomLoading?"loading":"more":"noMore",contentText:{contentdown:"上拉显示更多",contentrefresh:"正在加载...",contentnomore:"没有更多数据了"}})}:{},{s:o.scollerHeight+"px",t:n.refresherEnabled,v:n.attentionArticles.isRefresh,w:n.scrollInto,x:e.o((e=>o.onAttentionIsRefresh())),y:e.o((e=>o.onAttentionScrolltolower())),z:n.tabSelect,A:o.scollerHeight+"px",B:e.o(((...e)=>o.onSwiperChange&&o.onSwiperChange(...e))),C:e.o(((...e)=>o.onSwiperTransition&&o.onSwiperTransition(...e))),D:e.o(((...e)=>o.onSwiperAnimationfinish&&o.onSwiperAnimationfinish(...e))),E:n.editUserMessageItem.userId},n.editUserMessageItem.userId?{F:e.o((e=>o.onUserMessageDeleteClick(n.editUserMessageItem))),G:e.p({icon:"icon-delete",title:"删除对话"}),H:e.o((e=>o.onUserMessageReportClick(n.editUserMessageItem))),I:e.p({icon:"icon-alert",title:"举报用户"})}:{},{J:e.sr("userMessageActionPopup","403d4490-8"),K:e.p({needHead:!0,title:"消息选择",needCancelButton:!0}),L:n.editOfficialNewsItem.type},n.editOfficialNewsItem.type?{M:e.o((e=>o.onOfficialNewsDeleteClick(n.editOfficialNewsItem))),N:e.p({icon:"icon-delete",title:"删除对话"})}:{},{O:e.sr("officialNewsActionPopup","403d4490-11"),P:e.p({needHead:!0,title:"消息选择",needCancelButton:!0}),Q:n.editArticleItem.id},n.editArticleItem.id?e.e({R:1==n.editArticleItem.publisher.isAttention},1==n.editArticleItem.publisher.isAttention?{S:e.o((e=>o.onCancelFollow(n.editArticleItem))),T:e.p({icon:"icon-quxiaoguanzhu",title:"取消关注"})}:{U:e.o((e=>o.onFollow(n.editArticleItem))),V:e.p({icon:"icon-guanzhu",title:"关注"})},{W:e.o((e=>o.onChatClick(n.editArticleItem))),X:e.p({icon:"icon-message",title:"私聊"}),Y:e.o((e=>o.onPopupReportClick(n.editArticleItem))),Z:e.p({icon:"icon-alert",title:"举报"})}):{},{aa:e.sr("articleActionPopup","403d4490-13"),ab:e.p({needHead:!0,title:"动态选择",needCancelButton:!0})})}]]);u.__runtimeHooks=2,wx.createPage(g);
