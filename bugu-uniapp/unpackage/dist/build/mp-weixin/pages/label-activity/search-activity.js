"use strict";var e=require("../../common/vendor.js"),t=require("../../common/requestFunctions.js"),i=require("../../common/storageKeys.js"),o=require("../../common/storageFunctions.js"),s=require("../../utils/request.js"),n=require("../../common/constants.js");const a={data:()=>({searchText:"",searchTextBefore:"",haveMoreData:!1,articles:[],showBottomLoading:!1,page:1,editArticleItem:{},scrollInto:"",hotLabels:[],showHotLabels:!0,searchHistory:[],myId:-1}),async onLoad(){this.hotLabels=await t.getHotLabels();let s=await o.getMyUserInfo();s&&(this.myId=s.id);let n=e.index.getStorageSync(i.SEARCH_ACTIVITY_HISTORY);n&&(this.searchHistory=n)},methods:{onNarLeftClick(){e.index.navigateBack({delta:1})},onLabelTextClick(e){this.page=1,this.searchTextBefore=this.searchText=e,this.searchActivities(this.searchText,this.page)},onScrolltolower(){this.haveMoreData&&(this.page=this.page+1,this.searchText!==this.searchTextBefore?this.searchActivities(this.searchTextBefore,this.page):this.searchActivities(this.searchText,this.page))},onSearchInput(e){this.searchText=e},onSearchConfirm(){this.searchText.length<1?e.index.showToast({title:"请先输入关键词"}):(this.page=1,e.index.showLoading({title:"搜索中"}),this.searchTextBefore=this.searchText,this.searchActivities(this.searchText,this.page))},onActivityItemClick(t){e.index.navigateTo({url:`/pages/activity-info/activity-info?activityId=${t.id}`})},onMoreClick(e){this.$refs.articleActionPopup.open(),this.editArticleItem=e},onPopupReportClick(t){e.index.navigateTo({url:`/pages/setting/report-user/report-user?objectId=${t.id}&objectType=${n.reportObjectType.activity}`}),this.$refs.articleActionPopup.close()},onPopupDeleteClick(i){let o=this;e.index.showModal({title:"删除动态",content:"你确定要删除这个动态吗",success:async function(s){if(s.confirm&&await t.deleteMyArticle(i.id)){let t=o.articles;for(let e=0;e<t.length;e++)if(t[e].id==i.id){t.splice(e,1);break}o.articles=t,o.$refs.articleActionPopup.close(),e.index.showToast({title:"删除成功",icon:"success"})}}})},async onCancelFollow(i){if(!i.publisher)return;let o=this;e.index.showModal({title:"取消关注",content:`你确定要取消关注${i.publisher.username}`,success:async function(s){if(s.confirm&&i.publisher&&await t.cancelAttention(i.publisher.id)){let t=o.articles;for(let e=0;e<t.length;e++)t[e].publisher&&t[e].publisher.id==i.publisher.id&&(t[e].publisher.isAttention=0);o.articles=t,o.$refs.articleActionPopup.close(),e.index.showToast({title:"取消关注",icon:"success"})}}})},async onFollow(i){if(!i.publisher)return;let o=this;if(await t.followUser(i.publisher.id)){let t=o.articles;for(let e=0;e<t.length;e++)t[e].publisher&&t[e].publisher.id==i.publisher.id&&(t[e].publisher.isAttention=1);o.articles=t,o.$refs.articleActionPopup.close(),e.index.showToast({title:"关注成功",icon:"success"})}},async searchActivities(t,o){let a=await s.request({data:{method:"GET",group:"activity",action:"fullTextQuery",data:{page:o,subText:t},header:{"content-type":"application/x-www-form-urlencoded"}}});if(a.data.code===n.REQUEST_SUCCEEDED_CODE){let e=a.data.data.pageSum,i=a.data.data.list;if(this.haveMoreData=o<e,1===o)this.articles=i,this.scrollInto="";else{let e=this.articles.concat(i);this.articles=e}i.length<1&&o<e&&(this.page=o+1,this.searchActivities(t,this.page))}if(e.index.hideLoading(),this.showHotLabels=!1,1==o){let o=[],s=e.index.getStorageSync(i.SEARCH_ACTIVITY_HISTORY);s&&(o=s),-1==o.indexOf(t)?(o.push(t),o.length>10&&o.splice(0,1)):(o.splice(o.indexOf(t),1),o.push(t)),e.index.setStorage({key:i.SEARCH_ACTIVITY_HISTORY,data:o}),this.searchHistory=o.reverse()}}}};if(!Array){(e.resolveComponent("uni-nav-bar")+e.resolveComponent("uni-search-bar")+e.resolveComponent("activity-item")+e.resolveComponent("uni-load-more")+e.resolveComponent("action-sheet-item")+e.resolveComponent("action-sheet"))()}Math||((()=>"../../uni_modules/uni-nav-bar/components/uni-nav-bar/uni-nav-bar.js")+(()=>"../../uni_modules/uni-search-bar/components/uni-search-bar/uni-search-bar.js")+(()=>"../../components/activity-item/activity-item.js")+(()=>"../../uni_modules/uni-load-more/components/uni-load-more/uni-load-more.js")+(()=>"../../components/action-sheet-item/action-sheet-item.js")+(()=>"../../components/action-sheet/action-sheet.js"))();var r=e._export_sfc(a,[["render",function(t,i,o,s,n,a){return e.e({a:e.o((e=>a.onNarLeftClick())),b:e.p({"left-icon":"back",fixed:"true",backgroundColor:"#fff",color:"#808080",statusBar:"true"}),c:e.o((e=>a.onSearchConfirm())),d:e.o((e=>n.searchText=e)),e:e.p({placeholder:"搜索标签",cancelButton:"none",modelValue:n.searchText}),f:e.o((e=>a.onSearchConfirm())),g:n.showHotLabels},n.showHotLabels?e.e({h:n.searchHistory.length>0},n.searchHistory.length>0?{i:e.f(n.searchHistory,((t,i,o)=>({a:e.t(t),b:t,c:e.o((e=>a.onLabelTextClick(t)),t)})))}:{},{j:e.f(n.hotLabels,((t,i,o)=>({a:e.t(i+1),b:e.n(i<3?"label-index-hot":"label-index"),c:e.t(t.content),d:e.t(t.hot),e:t.id,f:e.o((e=>a.onLabelTextClick(t.content)),t.id)})))}):e.e({k:e.f(n.articles,((t,i,o)=>({a:t.id,b:e.o((e=>a.onActivityItemClick(t)),t.id),c:e.o((e=>a.onFollow(t)),t.id),d:e.o((e=>a.onMoreClick(t)),t.id),e:"242ffa68-2-"+o,f:e.p({articleItem:t,isMe:t.publisher&&n.myId==t.publisher.id})}))),l:n.articles.length<0},n.articles.length<0?{}:{m:e.p({status:n.haveMoreData?n.showBottomLoading?"loading":"more":"noMore",contentText:{contentdown:"上拉显示更多",contentrefresh:"正在加载...",contentnomore:"没有更多数据了"},iconType:"circle"})},{n:n.scrollInto,o:e.o(((...e)=>a.onScrolltolower&&a.onScrolltolower(...e)))}),{p:n.editArticleItem.id},n.editArticleItem.id?e.e({q:n.editArticleItem.isAnonymity},n.editArticleItem.isAnonymity?{r:e.o((e=>a.onPopupReportClick(n.editArticleItem))),s:e.p({icon:"icon-alert",title:"举报"})}:e.e({t:n.editArticleItem.publisher.id==n.myId},n.editArticleItem.publisher.id==n.myId?{v:e.o(a.onPopupDeleteClick),w:e.p({icon:"icon-delete",title:"删除"})}:e.e({x:1==n.editArticleItem.publisher.isAttention},1==n.editArticleItem.publisher.isAttention?{y:e.o((e=>a.onCancelFollow(n.editArticleItem))),z:e.p({icon:"icon-quxiaoguanzhu",title:"取消关注"})}:{A:e.o((e=>a.onFollow(n.editArticleItem))),B:e.p({icon:"icon-guanzhu",title:"关注"})},{C:e.p({icon:"icon-message",title:"私聊"}),D:e.o((e=>a.onPopupReportClick(n.editArticleItem))),E:e.p({icon:"icon-alert",title:"举报"})}))):{},{F:e.sr("articleActionPopup","242ffa68-4"),G:e.p({needHead:!0,title:"动态选择",needCancelButton:!0})})}]]);wx.createPage(r);
