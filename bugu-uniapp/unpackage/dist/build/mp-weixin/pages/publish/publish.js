"use strict";var e=require("../../common/vendor.js"),t=require("../../common/storageFunctions.js"),i=require("../../utils/aes/export.js"),o=require("../../common/constants.js"),a=require("../../utils/request.js");require("../../common/storageKeys.js");const n={data:()=>({articleText:"",imageFiles:[],videoFiles:[],labels:[],labelSelect:[],labelSelectIds:[],isAnonymity:0,privateSelect:0,privateSettingGroup:o.privateSettingGroup,showEmojiPicker:!1,labelPage:1,isShowAnonymity:!1,buttonIsLoading:!1,labelSearchText:""}),async beforeMount(){this.isShowAnonymity=await this.getAnonymityState(),this.getLabels(this.labelPage)},onLoad(e){let t=e.labelId,i=e.labelContent;t&&i&&(this.labelSelect=[{id:t,content:i,hot:0}],this.labelSelectIds=[t])},methods:{onNarLeftClick(){e.index.navigateBack({delta:1})},onTextareaInput(e){this.articleText=e.detail.value},onImageFilesSelect(e){let t=this.imageFiles;e.tempFilePaths.forEach(((i,o)=>{t.push({url:i,file:e.tempFiles[o]})})),this.imageFiles=t},setEmoj(e){this.articleText=this.articleText+e},onSwitchClick(){this.isAnonymity=1==this.isAnonymity?0:1},onPrivaterChooseClick(){this.$refs.privateSelectPopup.open()},onPrivaterAdioChange(e){for(let t=0;t<this.privateSettingGroup.length;t++)if(this.privateSettingGroup[t]===e.detail.value){this.privateSelect=t;break}},onAddLabelClick(){this.$refs.labelPopup.open()},onChooseLabelClick(t){let i=this.labelSelect,o=this.labelSelectIds;if(-1==o.indexOf(t.id)){if(this.labelSelect.length>=5)return void e.index.showToast({title:"最多只能选择五个哦~",icon:"none"});o.push(t.id),i.push(t)}else{for(let e=0;e<o.length;e++)if(o[e]==t.id){o.splice(e,1);break}for(let e=0;e<i.length;e++)if(i[e].id==t.id){i.splice(e,1);break}}this.labelSelect=i,this.labelSelectIds=o},onSearchInput(e){this.labelSearchText=e},onSearchConfirm(){this.labelSearchText.length<1?e.index.showToast({title:"请先输入内容",icon:"none"}):this.searchLabels(this.labelSearchText)},onRefreshLabelClick(){this.getLabels(this.labelPage)},onImageIconClick(){if(this.videoFiles.length>0)return void e.index.showModal({title:"无法选择图片",content:"一个动态不支持同时发布视频和图片哦~"});let t=this,i=9-this.imageFiles.length;i<=0?e.index.showToast({title:"最多选择9张哦~",icon:"none"}):e.index.chooseImage({count:i,sizeType:["original","compressed"],sourceType:["album"],success:function(e){let i=t.imageFiles;Array.isArray(e.tempFilePaths)&&e.tempFilePaths.forEach(((t,o)=>{i.push({url:t,file:e.tempFiles[o]})})),t.imageFiles=i}})},onCameraIconClick(){if(this.videoFiles.length>0)return void e.index.showModal({title:"无法选择图片",content:"一个动态不支持同时发布视频和图片哦~"});let t=this;9-this.imageFiles.length<=0?e.index.showToast({title:"最多选择9张哦~",icon:"none"}):e.index.chooseImage({count:1,sizeType:["original","compressed"],sourceType:["camera"],success:function(e){var i=t.imageFiles;Array.isArray(e.tempFilePaths)&&(e.tempFilePaths.forEach(((t,o)=>{i.push({url:t,file:e.tempFiles[o]})})),t.imageFiles=i)}})},async onVideoIconClick(){let i=await t.getMyUserInfo();i?1==i.isVerify&&i.vip&&i.vip.remainDays>0?this.imageFiles.length>0?e.index.showModal({title:"无法选择视频",content:"一个动态不支持同时发布视频和图片哦~"}):this.videoFiles.length>=1?e.index.showModal({title:"无法选择视频",content:"一个动态只能选择一个视频"}):e.index.chooseVideo({sourceType:["camera","album"],maxDuration:60,camera:"back",success:t=>{t.duration>210?e.index.showModal({title:"选择失败",content:"只能选择3分30秒以下的视屏哦~"}):this.videoFiles=[{url:t.tempFilePath}]}}):e.index.showModal({title:"选择失败",content:"只有实名认证并且为vip用户才能发布视频哦~"}):e.index.showModal({title:"无法选择",content:"您还未登录，请先登录",success:function(t){t.confirm&&e.index.navigateTo({url:"../login/login"})}})},onEmojiIconClick(){this.showEmojiPicker=!this.showEmojiPicker},onEmojiPickerCloseClick(){this.showEmojiPicker=!1},async searchLabels(t){let i=await a.request({data:{method:"GET",group:"activity",action:"label/query",data:{content:t},header:{"content-type":"application/x-www-form-urlencoded"}}});if(i.data.code===o.REQUEST_SUCCEEDED_CODE){let e=i.data.data;if(e.length<=0){let e=await this.addLabel(t);0!=e&&(this.labels=[{id:e,content:this.labelSearchText,hot:0}],this.labelSearchText="")}else this.labels=e,this.labelSearchText=""}else e.index.showToast({title:i.data.userMSg,icon:"none"})},async addLabel(e){let t=await a.request({data:{method:"PUT",group:"activity",action:"label/add",data:{content:e},header:{"content-type":"application/x-www-form-urlencoded"}}});return t.data.code===o.REQUEST_SUCCEEDED_CODE?t.data.data:0},async getLabels(e){let t=await a.request({data:{method:"GET",group:"activity",action:"label/list",data:{page:e},header:{"content-type":"application/x-www-form-urlencoded"}}});if(t.data.code===o.REQUEST_SUCCEEDED_CODE){let i=t.data.data,o=t.data.data.list;e<i.pageSum?this.labelPage=this.labelPage+1:this.labelPage=1;for(let e=0;e<this.labelSelect.length;e++){let t=!1;for(let i=0;i<o.length;i++)if(o[i].id==this.labelSelect[e].id){t=!0;break}t||o.push(this.labelSelect[e])}this.labels=o}},async getAnonymityState(){let e=await a.request({data:{method:"GET",group:"activity",action:"anonymity/state",data:{},header:{"content-type":"application/x-www-form-urlencoded"}}});return e.data.code===o.REQUEST_SUCCEEDED_CODE&&e.data.data},async prepareBeforePublic(){let n=await t.getMyUserInfo();if(!n)return void e.index.showModal({title:"发布失败",content:"您还未登录，请先登录",success:function(t){t.confirm&&e.index.navigateTo({url:"../login/login"})}});if(this.articleText.length<=0&&this.imageFiles.length<=0&&this.videoFiles.length<=0)return void e.index.showToast({title:"请先输入内容",icon:"none"});e.index.showLoading({title:"正在发布"}),this.buttonIsLoading=!0;let l=0,s=[],c=[];var r=this;let h,d=0;if(this.imageFiles.length>0){if(d=this.imageFiles.length,c=this.imageFiles,this.videoFiles.length>0)return void e.index.showModal({title:"发布失败",content:"一个动态不能同时发布视频和图片哦~"})}else if(this.videoFiles.length>0){if(!(1==n.isVerify&&n.vip&&n.vip.remainDays>0))return void e.index.showModal({title:"发布失败",content:"只有实名认证并且为vip用户才能发布视频哦~"});l=1,d=this.videoFiles.length,c=this.videoFiles}if(d<1)return void this.publishArticle(this.articleText,s,this.privateSelect,this.isAnonymity,this.labelSelectIds);let u=await a.request({data:{method:"GET",group:"activity",action:"publish/getToken",data:{sum:d},header:{"content-type":"application/x-www-form-urlencoded"}}});u.data.code===o.REQUEST_SUCCEEDED_CODE?(h=u.data.data,h.forEach((e=>{s.push(e.fileName)})),c.forEach((async(t,a)=>{e.index.uploadFile({url:o.UploadUrl,filePath:t.url,name:"file",formData:{key:h[a].fileName,token:i.aes.decrypt(h[a].token)},success(e){a===c.length-1&&r.publishArticle(r.articleText,s,r.privateSelect,r.isAnonymity,r.labelSelectIds,l)}})}))):e.index.showToast({title:"没有权限，请先登录",icon:"none"})},async publishArticle(t,i,n,l,s,c=0){let r=await a.request({data:{method:"POST",group:"activity",action:"publish",data:{text:t,pic:JSON.stringify(i),visibility:n,isAnonymity:l,labelIds:s.length>0?JSON.stringify(s):"",video:c},header:{"content-type":"application/x-www-form-urlencoded"}}});e.index.hideLoading(),this.buttonIsLoading=!1,r.data.code===o.REQUEST_SUCCEEDED_CODE&&(e.index.showToast({title:"发布成功",icon:"success"}),this.articleText="",this.imageFiles=[],this.labelSelect=[],this.labelSelectIds=[],this.videoFiles=[],e.index.switchTab({url:"/pages/index/index"}))}}};if(!Array){(e.resolveComponent("uni-nav-bar")+e.resolveComponent("uni-file-picker")+e.resolveComponent("uni-tag")+e.resolveComponent("uni-icons")+e.resolveComponent("emoji")+e.resolveComponent("uni-transition")+e.resolveComponent("uni-search-bar")+e.resolveComponent("uni-popup")+e.resolveComponent("action-sheet"))()}Math||((()=>"../../uni_modules/uni-nav-bar/components/uni-nav-bar/uni-nav-bar.js")+(()=>"../../uni_modules/uni-file-picker/components/uni-file-picker/uni-file-picker.js")+(()=>"../../uni_modules/uni-tag/components/uni-tag/uni-tag.js")+(()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../components/emoji/emoji.js")+(()=>"../../uni_modules/uni-transition/components/uni-transition/uni-transition.js")+(()=>"../../uni_modules/uni-search-bar/components/uni-search-bar/uni-search-bar.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js")+(()=>"../../components/action-sheet/action-sheet.js"))();var l=e._export_sfc(n,[["render",function(t,i,o,a,n,l){return e.e({a:e.o((e=>l.onNarLeftClick())),b:e.p({"left-icon":"back",fixed:"true",backgroundColor:"#fff",color:"#808080",statusBar:"true"}),c:n.articleText,d:e.o(((...e)=>l.onTextareaInput&&l.onTextareaInput(...e))),e:n.imageFiles.length>0},n.imageFiles.length>0?{f:e.o(l.onImageFilesSelect),g:e.o((e=>n.imageFiles=e)),h:e.p({fileMediatype:"image",mode:"grid",limit:"9",modelValue:n.imageFiles})}:{},{i:e.f(n.videoFiles,((e,t,i)=>({a:`video_${t}`,b:e.url,c:t}))),j:e.f(n.labelSelect,((t,i,o)=>({a:t.id,b:"a77122c0-2-"+o,c:e.p({size:"small",text:`#${t.content}`,circle:!0})}))),k:n.isShowAnonymity},n.isShowAnonymity?{l:1==n.isAnonymity,m:e.o((e=>l.onSwitchClick()))}:{},{n:e.o((e=>l.onAddLabelClick())),o:e.t(n.privateSettingGroup[n.privateSelect]),p:e.p({color:"#b4b4b4",type:"right",size:"20"}),q:e.o((e=>l.onPrivaterChooseClick())),r:e.o((e=>l.onImageIconClick())),s:e.o((e=>l.onCameraIconClick())),t:e.o((e=>l.onVideoIconClick())),v:e.o((e=>l.onEmojiIconClick())),w:e.t(n.articleText.length),x:e.o((e=>l.prepareBeforePublic())),y:n.buttonIsLoading,z:e.o((e=>l.onEmojiPickerCloseClick())),A:e.p({customPrefix:"customicons",type:"closeempty",color:"#808080",size:"25"}),B:e.o(l.setEmoj),C:e.p({"mode-class":"slide-bottom",show:n.showEmojiPicker}),D:e.o((e=>l.onSearchConfirm())),E:e.o((e=>n.labelSearchText=e)),F:e.p({placeholder:"搜索标签",cancelButton:"none",modelValue:n.labelSearchText}),G:e.o((e=>l.onSearchConfirm())),H:e.f(n.labels,((t,i,o)=>({a:t.id,b:e.o((e=>l.onChooseLabelClick(t)),t.id),c:"a77122c0-9-"+o+",a77122c0-7",d:e.p({type:-1!=n.labelSelectIds.indexOf(t.id)?"primary":"default",text:t.content,size:"default",circle:!0})}))),I:e.o((e=>l.onRefreshLabelClick())),J:e.sr("labelPopup","a77122c0-7"),K:e.p({backgroundColor:"#ffffff",type:"bottom"}),L:e.f(n.privateSettingGroup,((t,i,o)=>({a:e.t(t),b:t,c:i===n.privateSelect,d:t}))),M:e.o(((...e)=>l.onPrivaterAdioChange&&l.onPrivaterAdioChange(...e))),N:e.sr("privateSelectPopup","a77122c0-10"),O:e.p({needHead:!0,title:"权限设置"})})}]]);wx.createPage(l);
