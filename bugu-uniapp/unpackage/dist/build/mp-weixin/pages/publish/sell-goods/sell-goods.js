"use strict";var e=require("../../../common/vendor.js"),t=require("../../../common/storageFunctions.js"),i=require("../../../common/constants.js"),o=require("../../../utils/request.js");require("../../../common/storageKeys.js");const a={data:()=>({goodsText:"",goodsPrice:"0.00",imageFiles:[],videoFiles:[],labels:[],labelSelect:[],labelSelectIds:[],isAnonymity:0,showEmojiPicker:!1,labelPage:1,buttonIsLoading:!1,labelSearchText:""}),async beforeMount(){this.getLabels(this.labelPage)},methods:{onNarLeftClick(){e.index.navigateBack({delta:1})},onTextareaInput(e){this.goodsText=e.detail.value},onPriceInput(e){this.goodsPrice=e.detail.value},onImageFilesSelect(e){let t=this.imageFiles;e.tempFilePaths.forEach(((i,o)=>{t.push({url:i,file:e.tempFiles[o]})})),this.imageFiles=t},setEmoj(e){this.goodsText=this.goodsText+e},onSwitchClick(){this.isAnonymity=1==this.isAnonymity?0:1},onPrivaterChooseClick(){this.$refs.privateSelectPopup.open()},onPrivaterAdioChange(e){for(let t=0;t<this.privateSettingGroup.length;t++)if(this.privateSettingGroup[t]===e.detail.value){this.privateSelect=t;break}},onAddLabelClick(){this.$refs.labelPopup.open()},onChooseLabelClick(t){let i=this.labelSelect,o=this.labelSelectIds;if(-1==o.indexOf(t.id)){if(this.labelSelect.length>=5)return void e.index.showToast({title:"最多只能选择五个哦~",icon:"none"});o.push(t.id),i.push(t)}else{for(let e=0;e<o.length;e++)if(o[e]==t.id){o.splice(e,1);break}for(let e=0;e<i.length;e++)if(i[e].id==t.id){i.splice(e,1);break}}this.labelSelect=i,this.labelSelectIds=o},onSearchInput(e){this.labelSearchText=e},onSearchConfirm(){this.labelSearchText.length<1?e.index.showToast({title:"请先输入内容",icon:"none"}):this.searchLabels(this.labelSearchText)},onRefreshLabelClick(){this.getLabels(this.labelPage)},onImageIconClick(){if(this.videoFiles.length>0)return void e.index.showModal({title:"无法选择图片",content:"一个动态不支持同时发布视频和图片哦~"});let t=this,i=9-this.imageFiles.length;i<=0?e.index.showToast({title:"最多选择9张哦~",icon:"none"}):e.index.chooseImage({count:i,sizeType:["original","compressed"],sourceType:["album"],success:function(e){let i=t.imageFiles;Array.isArray(e.tempFilePaths)&&e.tempFilePaths.forEach(((t,o)=>{i.push({url:t,file:e.tempFiles[o]})})),t.imageFiles=i}})},onCameraIconClick(){if(this.videoFiles.length>0)return void e.index.showModal({title:"无法选择图片",content:"一个动态不支持同时发布视频和图片哦~"});let t=this;9-this.imageFiles.length<=0?e.index.showToast({title:"最多选择9张哦~",icon:"none"}):e.index.chooseImage({count:1,sizeType:["original","compressed"],sourceType:["camera"],success:function(e){var i=t.imageFiles;Array.isArray(e.tempFilePaths)&&(e.tempFilePaths.forEach(((t,o)=>{i.push({url:t,file:e.tempFiles[o]})})),t.imageFiles=i)}})},async onVideoIconClick(){let i=await t.getMyUserInfo();i?1==i.isVerify&&i.vip&&i.vip.remainDays>0?this.imageFiles.length>0?e.index.showModal({title:"无法选择视频",content:"一个动态不支持同时发布视频和图片哦~"}):this.videoFiles.length>=1?e.index.showModal({title:"无法选择视频",content:"一个动态只能选择一个视频"}):e.index.chooseVideo({sourceType:["camera","album"],maxDuration:60,camera:"back",success:t=>{t.duration>210?e.index.showModal({title:"选择失败",content:"只能选择3分30秒以下的视屏哦~"}):this.videoFiles=[{url:t.tempFilePath}]}}):e.index.showModal({title:"选择失败",content:"只有实名认证并且为vip用户才能发布视频哦~"}):e.index.showModal({title:"无法选择",content:"您还未登录，请先登录",success:function(t){t.confirm&&e.index.navigateTo({url:"../login/login"})}})},async searchLabels(t){let a=await o.request({data:{method:"GET",group:"activity",action:"label/query",data:{content:t},header:{"content-type":"application/x-www-form-urlencoded"}}});if(a.data.code===i.REQUEST_SUCCEEDED_CODE){let e=a.data.data;if(e.length<=0){let e=await this.addLabel(t);0!=e&&(this.labels=[{id:e,content:this.labelSearchText,hot:0}],this.labelSearchText="")}else this.labels=e,this.labelSearchText=""}else e.index.showToast({title:a.data.userMSg,icon:"none"})},async addLabel(e){let t=await o.request({data:{method:"PUT",group:"activity",action:"label/add",data:{content:e},header:{"content-type":"application/x-www-form-urlencoded"}}});return t.data.code===i.REQUEST_SUCCEEDED_CODE?t.data.data:0},async getLabels(e){let t=await o.request({data:{method:"GET",group:"activity",action:"label/list",data:{page:e},header:{"content-type":"application/x-www-form-urlencoded"}}});if(t.data.code===i.REQUEST_SUCCEEDED_CODE){let i=t.data.data,o=t.data.data.list;e<i.pageSum?this.labelPage=this.labelPage+1:this.labelPage=1;for(let e=0;e<this.labelSelect.length;e++){let t=!1;for(let i=0;i<o.length;i++)if(o[i].id==this.labelSelect[e].id){t=!0;break}t||o.push(this.labelSelect[e])}this.labels=o}},async prepareBeforePublic(){await t.getMyUserInfo()?this.goodsText.length<=0?e.index.showToast({title:"请先输入内容",icon:"none"}):this.imageFiles.length<=0&&this.videoFiles.length<=0?e.index.showToast({title:"请先上传商品图片或视频",icon:"none"}):this.goodsPrice<=0&&e.index.showToast({title:"请先输入商品价格",icon:"none"}):e.index.showModal({title:"发布失败",content:"您还未登录，请先登录",success:function(t){t.confirm&&e.index.navigateTo({url:"../login/login"})}})},async publishgoods(t,a,l,n,s,c=0){let r=await o.request({data:{method:"POST",group:"activity",action:"publish",data:{text:t,pic:JSON.stringify(a),visibility:l,isAnonymity:n,labelIds:s.length>0?JSON.stringify(s):"",video:c},header:{"content-type":"application/x-www-form-urlencoded"}}});e.index.hideLoading(),this.buttonIsLoading=!1,r.data.code===i.REQUEST_SUCCEEDED_CODE&&(e.index.showToast({title:"发布成功",icon:"success"}),this.goodsText="",this.imageFiles=[],this.labelSelect=[],this.labelSelectIds=[],this.videoFiles=[],e.index.switchTab({url:"/pages/index/index"}))}}};if(!Array){(e.resolveComponent("uni-nav-bar")+e.resolveComponent("uni-file-picker")+e.resolveComponent("uni-tag")+e.resolveComponent("uni-search-bar")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../../uni_modules/uni-nav-bar/components/uni-nav-bar/uni-nav-bar.js")+(()=>"../../../uni_modules/uni-file-picker/components/uni-file-picker/uni-file-picker.js")+(()=>"../../../uni_modules/uni-tag/components/uni-tag/uni-tag.js")+(()=>"../../../uni_modules/uni-search-bar/components/uni-search-bar/uni-search-bar.js")+(()=>"../../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();var l=e._export_sfc(a,[["render",function(t,i,o,a,l,n){return e.e({a:e.o((e=>n.onNarLeftClick())),b:e.p({"left-icon":"back",fixed:"true",backgroundColor:"#fff",color:"#808080",statusBar:"true"}),c:l.goodsText,d:e.o(((...e)=>n.onTextareaInput&&n.onTextareaInput(...e))),e:l.imageFiles.length>0},l.imageFiles.length>0?{f:e.o(n.onImageFilesSelect),g:e.o((e=>l.imageFiles=e)),h:e.p({fileMediatype:"image",mode:"grid",limit:"9",modelValue:l.imageFiles})}:{},{i:e.f(l.videoFiles,((e,t,i)=>({a:`video_${t}`,b:e.url,c:t}))),j:e.f(l.labelSelect,((t,i,o)=>({a:t.id,b:"fe522740-2-"+o,c:e.p({size:"small",text:`#${t.content}`,circle:!0})}))),k:e.o((e=>n.onAddLabelClick())),l:e.o((e=>n.onImageIconClick())),m:e.o((e=>n.onCameraIconClick())),n:e.o((e=>n.onVideoIconClick())),o:e.t(l.goodsText.length),p:e.o(((...e)=>n.onPriceInput&&n.onPriceInput(...e))),q:l.goodsPrice,r:e.o((e=>n.prepareBeforePublic())),s:l.buttonIsLoading,t:e.o((e=>n.onSearchConfirm())),v:e.o((e=>l.labelSearchText=e)),w:e.p({placeholder:"搜索标签",cancelButton:"none",modelValue:l.labelSearchText}),x:e.o((e=>n.onSearchConfirm())),y:e.f(l.labels,((t,i,o)=>({a:t.id,b:e.o((e=>n.onChooseLabelClick(t)),t.id),c:"fe522740-5-"+o+",fe522740-3",d:e.p({type:-1!=l.labelSelectIds.indexOf(t.id)?"primary":"default",text:t.content,size:"default",circle:!0})}))),z:e.o((e=>n.onRefreshLabelClick())),A:e.sr("labelPopup","fe522740-3"),B:e.p({backgroundColor:"#ffffff",type:"bottom"})})}]]);wx.createPage(l);
