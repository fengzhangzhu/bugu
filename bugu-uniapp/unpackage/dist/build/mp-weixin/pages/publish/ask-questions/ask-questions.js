"use strict";var e=require("../../../common/vendor.js"),t=require("../../../common/storageFunctions.js"),i=require("../../../utils/aes/export.js"),o=require("../../../common/constants.js"),n=require("../../../utils/request.js");require("../../../common/storageKeys.js");const a={data:()=>({questionText:"",questionDescription:"",imageFiles:[],videoFiles:[],labels:[],labelSelect:[],labelSelectIds:[],isAnonymity:0,showEmojiPicker:!1,labelPage:1,isShowAnonymity:!1,buttonIsLoading:!1,labelSearchText:""}),async beforeMount(){this.isShowAnonymity=await this.getAnonymityState(),this.getLabels(this.labelPage)},onLoad(e){let t=e.labelId,i=e.labelContent;t&&i&&(this.labelSelect=[{id:t,content:i,hot:0}],this.labelSelectIds=[t])},methods:{onNarLeftClick(){e.index.navigateBack({delta:1})},onTextareaInput(e){this.questionDescription=e.detail.value},onQuestionInput(e){this.questionText=e.detail.value},onImageFilesSelect(e){let t=this.imageFiles;e.tempFilePaths.forEach(((i,o)=>{t.push({url:i,file:e.tempFiles[o]})})),this.imageFiles=t},setEmoj(e){this.questionText=this.questionText+e},onSwitchClick(){this.isAnonymity=1==this.isAnonymity?0:1},onAddLabelClick(){this.$refs.labelPopup.open()},onChooseLabelClick(t){let i=this.labelSelect,o=this.labelSelectIds;if(-1==o.indexOf(t.id)){if(this.labelSelect.length>=5)return void e.index.showToast({title:"最多只能选择五个哦~",icon:"none"});o.push(t.id),i.push(t)}else{for(let e=0;e<o.length;e++)if(o[e]==t.id){o.splice(e,1);break}for(let e=0;e<i.length;e++)if(i[e].id==t.id){i.splice(e,1);break}}this.labelSelect=i,this.labelSelectIds=o},onSearchInput(e){this.labelSearchText=e},onSearchConfirm(){this.labelSearchText.length<1?e.index.showToast({title:"请先输入内容",icon:"none"}):this.searchLabels(this.labelSearchText)},onRefreshLabelClick(){this.getLabels(this.labelPage)},onImageIconClick(){if(this.videoFiles.length>0)return void e.index.showModal({title:"无法选择图片",content:"一个动态不支持同时发布视频和图片哦~"});let t=this,i=9-this.imageFiles.length;i<=0?e.index.showToast({title:"最多选择9张哦~",icon:"none"}):e.index.chooseImage({count:i,sizeType:["original","compressed"],sourceType:["album"],success:function(e){let i=t.imageFiles;Array.isArray(e.tempFilePaths)&&e.tempFilePaths.forEach(((t,o)=>{i.push({url:t,file:e.tempFiles[o]})})),t.imageFiles=i}})},onCameraIconClick(){if(this.videoFiles.length>0)return void e.index.showModal({title:"无法选择图片",content:"一个动态不支持同时发布视频和图片哦~"});let t=this;9-this.imageFiles.length<=0?e.index.showToast({title:"最多选择9张哦~",icon:"none"}):e.index.chooseImage({count:1,sizeType:["original","compressed"],sourceType:["camera"],success:function(e){var i=t.imageFiles;Array.isArray(e.tempFilePaths)&&(e.tempFilePaths.forEach(((t,o)=>{i.push({url:t,file:e.tempFiles[o]})})),t.imageFiles=i)}})},async onVideoIconClick(){if(this.imageFiles.length>0)return void e.index.showModal({title:"无法选择视频",content:"一个问题不支持同时发布视频和图片哦~"});let i=await t.getMyUserInfo();i?1==i.isVerify&&i.vip&&i.vip.remainDays>0?e.index.chooseVideo({sourceType:["camera","album"],maxDuration:60,camera:"back",success:t=>{t.duration>210?e.index.showModal({title:"选择失败",content:"只能选择3分30秒以下的视屏哦~"}):this.videoFiles=[{url:t.tempFilePath}]}}):e.index.showModal({title:"选择失败",content:"只有实名认证并且为vip用户才能发布视频哦~"}):e.index.showModal({title:"无法选择",content:"您还未登录，请先登录",success:function(t){t.confirm&&e.index.navigateTo({url:"../login/login"})}})},async searchLabels(t){let i=await n.request({data:{method:"GET",group:"question",action:"label/query",data:{content:t},header:{"content-type":"application/x-www-form-urlencoded"}}});if(i.data.code===o.REQUEST_SUCCEEDED_CODE){let e=i.data.data;if(e.length<=0){let e=await this.addLabel(t);0!=e&&(this.labels=[{id:e,content:this.labelSearchText,hot:0}],this.labelSearchText="")}else this.labels=e,this.labelSearchText=""}else if("NOT_FOUND"===i.data.code){let e=await this.addLabel(t);0!=e&&(this.labels=[{id:e,content:this.labelSearchText,hot:0}],this.labelSearchText="")}else e.index.showToast({title:i.data.userMsg,icon:"none"})},async addLabel(e){let t=await n.request({data:{method:"PUT",group:"question",action:"label/add",data:{content:e},header:{"content-type":"application/x-www-form-urlencoded"}}});return t.data.code===o.REQUEST_SUCCEEDED_CODE?t.data.data:0},async getLabels(e){let t=await n.request({data:{method:"GET",group:"question",action:"label/list",data:{page:e},header:{"content-type":"application/x-www-form-urlencoded"}}});if(t.data.code===o.REQUEST_SUCCEEDED_CODE){let e=t.data.data,i=e.list;e.hasNext?this.labelPage=this.labelPage+1:this.labelPage=1;for(let t=0;t<this.labelSelect.length;t++){let e=!1;for(let o=0;o<i.length;o++)if(i[o].id==this.labelSelect[t].id){e=!0;break}e||i.push(this.labelSelect[t])}this.labels=i}else console.error(t.data)},async getAnonymityState(){let e=await n.request({data:{method:"GET",group:"activity",action:"anonymity/state",data:{},header:{"content-type":"application/x-www-form-urlencoded"}}});return e.data.code===o.REQUEST_SUCCEEDED_CODE&&e.data.data},async prepareBeforePublic(){let a=await t.getMyUserInfo();if(!a)return void e.index.showModal({title:"发布失败",content:"您还未登录，请先登录",success:function(t){t.confirm&&e.index.navigateTo({url:"../login/login"})}});if(this.questionText.length<=0)return void e.index.showToast({title:"请先输入内容",icon:"none"});if("?"!=this.questionText.charAt(this.questionText.length-1)&&"？"!=this.questionText.charAt(this.questionText.length-1))return void e.index.showToast({title:"请以问号结尾",icon:"none"});e.index.showLoading({title:"正在发布"}),this.buttonIsLoading=!0;let s=0,l=[],r=[];var c=this;let d=0;if(this.imageFiles.length>0){if(d=this.imageFiles.length,r=this.imageFiles,this.videoFiles.length>0)return void e.index.showModal({title:"发布失败",content:"一个问题不能同时发布视频和图片哦~"})}else if(this.videoFiles.length>0){if(!(1==a.isVerify&&a.vip&&a.vip.remainDays>0))return void e.index.showModal({title:"发布失败",content:"只有实名认证并且为vip用户才能发布视频哦~"});s=1,d=this.videoFiles.length,r=this.videoFiles}if(d<1)return await this.publishQuestion(this.questionText,this.questionDescription,this.isAnonymity,[],[],this.labelSelectIds),void e.index.hideLoading();let h,u={sum:d},p=await n.request({data:{method:"GET",group:"question",action:"publish/getToken",data:u,header:{"content-type":"application/x-www-form-urlencoded"}}});p.data.code===o.REQUEST_SUCCEEDED_CODE?(h=p.data.data,h.forEach((e=>{l.push(e.fileName)})),r.forEach((async(t,n)=>{e.index.uploadFile({url:o.UploadUrl,filePath:t.url,name:"file",formData:{key:h[n].fileName,token:i.aes.decrypt(h[n].token)},success(e){if(n===r.length-1){let e=[],t=[];1==s?t=l:e=l,c.publishQuestion(c.questionText,c.questionDescription,c.isAnonymity,e,t,c.labelSelectIds)}}})}))):e.index.showToast({title:"没有权限，请先登录",icon:"none"})},async publishQuestion(t,i,a,s,l,r){let c=await n.request({data:{method:"POST",group:"question",action:"publish",data:{title:t,text:i,isAnonymity:a,pics:JSON.stringify(s),video:JSON.stringify(l),labelIds:JSON.stringify(r)},header:{"content-type":"application/x-www-form-urlencoded"}}});e.index.hideLoading(),this.buttonIsLoading=!1,c.data.code===o.REQUEST_SUCCEEDED_CODE?(e.index.showToast({title:"发布成功",icon:"success"}),this.questionText="",this.imageFiles=[],this.labelSelect=[],this.labelSelectIds=[],this.videoFiles=[],e.index.navigateBack()):e.index.showToast({title:c.data.userMsg,icon:"error"})}}};if(!Array){(e.resolveComponent("uni-nav-bar")+e.resolveComponent("uni-file-picker")+e.resolveComponent("uni-tag")+e.resolveComponent("uni-icons")+e.resolveComponent("emoji")+e.resolveComponent("uni-transition")+e.resolveComponent("uni-search-bar")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../../uni_modules/uni-nav-bar/components/uni-nav-bar/uni-nav-bar.js")+(()=>"../../../uni_modules/uni-file-picker/components/uni-file-picker/uni-file-picker.js")+(()=>"../../../uni_modules/uni-tag/components/uni-tag/uni-tag.js")+(()=>"../../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../../components/emoji/emoji.js")+(()=>"../../../uni_modules/uni-transition/components/uni-transition/uni-transition.js")+(()=>"../../../uni_modules/uni-search-bar/components/uni-search-bar/uni-search-bar.js")+(()=>"../../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();var s=e._export_sfc(a,[["render",function(t,i,o,n,a,s){return e.e({a:e.o((e=>s.onNarLeftClick())),b:e.p({"left-icon":"back",fixed:"true",backgroundColor:"#fff",color:"#808080",statusBar:"true"}),c:a.questionText,d:e.o(((...e)=>s.onQuestionInput&&s.onQuestionInput(...e))),e:a.questionDescription,f:e.o(((...e)=>s.onTextareaInput&&s.onTextareaInput(...e))),g:a.imageFiles.length>0},a.imageFiles.length>0?{h:e.o(s.onImageFilesSelect),i:e.o((e=>a.imageFiles=e)),j:e.p({fileMediatype:"image",mode:"grid",limit:"9",modelValue:a.imageFiles})}:{},{k:e.f(a.videoFiles,((e,t,i)=>({a:`video_${t}`,b:e.url,c:t}))),l:e.f(a.labelSelect,((t,i,o)=>({a:t.id,b:"07a92374-2-"+o,c:e.p({size:"small",text:`#${t.content}`,circle:!0})}))),m:a.isShowAnonymity},a.isShowAnonymity?{n:1==a.isAnonymity,o:e.o((e=>s.onSwitchClick()))}:{},{p:e.o((e=>s.onAddLabelClick())),q:e.o((e=>s.onImageIconClick())),r:e.o((e=>s.onCameraIconClick())),s:e.o((e=>s.onVideoIconClick())),t:e.o((e=>s.prepareBeforePublic())),v:a.buttonIsLoading,w:e.o((e=>t.onEmojiPickerCloseClick())),x:e.p({customPrefix:"customicons",type:"closeempty",color:"#808080",size:"25"}),y:e.o(s.setEmoj),z:e.p({"mode-class":"slide-bottom",show:a.showEmojiPicker}),A:e.o((e=>s.onSearchConfirm())),B:e.o((e=>a.labelSearchText=e)),C:e.p({placeholder:"搜索标签",cancelButton:"none",modelValue:a.labelSearchText}),D:e.o((e=>s.onSearchConfirm())),E:e.f(a.labels,((t,i,o)=>({a:t.id,b:e.o((e=>s.onChooseLabelClick(t)),t.id),c:"07a92374-8-"+o+",07a92374-6",d:e.p({type:-1!=a.labelSelectIds.indexOf(t.id)?"primary":"default",text:t.content,size:"default",circle:!0})}))),F:e.o((e=>s.onRefreshLabelClick())),G:e.sr("labelPopup","07a92374-6"),H:e.p({backgroundColor:"#ffffff",type:"bottom"})})}]]);wx.createPage(s);
