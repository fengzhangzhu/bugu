"use strict";var e=require("../../../common/vendor.js"),t=require("../../../utils/dateUtils.js"),a=require("../../../common/storageFunctions.js"),s=require("../../../utils/messageUtils/storage.js"),o=require("../../../common/requestFunctions.js"),i=require("../../../common/constants.js"),r=require("../../../utils/request.js"),n=require("../../../utils/messageUtils/storageKeys.js"),h=require("../../../common/globalMsgKeys.js");require("../../../common/storageKeys.js");const c={data:()=>({fromUserInfo:{},myUserInfo:{},historyChats:[],scrollInto:"",page:1,haveMoreData:!0,GettimeifferenceOfNow:t.GettimeifferenceOfNow,navHeight:0,contentHeight:0,selectChatItem:{},moreText:"more",datePickerList:[],daySelected:"all"}),onReady(){let t=this;e.index.getSystemInfo({success(e){t.contentHeight=e.windowHeight}}),e.index.createSelectorQuery().select("#chat-scrollview").boundingClientRect((e=>{t.navHeight=e.top})).exec()},async onLoad(e){let t=e.fromUserId,s=await o.getUserinfo(t),i=await a.getMyUserInfo();this.myUserInfo=i,this.fromUserInfo=s,this.getAllChatHistory(t,this.page),this.getHistoryDateList(t)},computed:{fromUsername(){return this.fromUserInfo.username?this.fromUserInfo.username.length>7?this.fromUserInfo.username.slice(0,7)+"...":this.fromUserInfo.username:""},scollerHeight(){return this.contentHeight-this.navHeight-70}},methods:{onNarLeftClick(){e.index.navigateBack({delta:1})},onScrollToUpper(){this.haveMoreData&&this.fromUserInfo&&(this.page=this.page+1,"all"===this.daySelected?this.getAllChatHistory(this.fromUserInfo.id,this.page):this.getHistoryByDate(this.formUserInfo.id,this.daySelected,this.page))},onDatePikcerChange(e){this.daySelected=e.detail.value[1].value,this.page=1,this.getHistoryByDate(this.fromUserInfo.id,this.daySelected,this.page)},onCopyTextClick(){e.index.setClipboardData({data:this.selectChatItem.content}),this.$refs.chatItemActionPopup.close()},onAddExpressionClick(){let e=this.selectChatItem.content.replace(i.ImageFatherPath,"");this.addExpression(e),this.$refs.chatItemActionPopup.close()},onDeleteTextClick(){this.deleteMessage(this.selectChatItem.id),this.$refs.chatItemActionPopup.close()},onChatItemLongPress(e){this.selectChatItem=e,this.$refs.chatItemActionPopup.open()},showChatCreatTime(e){let a=this.historyChats,s=!1;if(0==e)s=!0;else{t.GetNumberOfMenit(a[e-1].createTime,a[e].createTime)>1&&(s=!0)}return s},addExpression:async t=>(await r.request({data:{method:"POST",group:"message",action:"emoticon/add",data:{filename:t},header:{"content-type":"application/x-www-form-urlencoded"}}})).data.code===i.REQUEST_SUCCEEDED_CODE&&(e.index.showToast({title:"添加成功",icon:"success"}),e.index.$emit(h.REFRESH_CHAT_CONTENT,{needRefresh:!0}),!0),async deleteMessage(t){if(this.historyChats){let a=this.historyChats;for(let e=a.length-1;e>=0;e--)if(a[e].id==t){a.splice(e,1);break}this.historyChats=a;let o=await s.getChatRecord(this.myUserInfo.id,this.fromUserInfo.id);if(o){let a=o.messages,i=0;for(let e=0;e<a.length;e++)if(t==a[e].id){a.splice(e,1),i=e;break}o.messages=a;let r=n.getChatRecordKey(this.myUserInfo.id,this.fromUserInfo.id);if(e.index.setStorage({key:r,data:o}),a.length>0&&i==a.length){let t=await s.getUserMessageList(this.myUserInfo.id);for(let e=0;e<t.length;e++)if(t[e].userId==this.fromUserInfo.id){let s=t[e];s.lastMessage=a[a.length-1].content,s.lastMessageType=a[a.length-1].type,s.lastTime=a[a.length-1].createTime,s.unreadSum=0,t.splice(e,1),t.push(s);break}let o=n.getUserMessageListKey(this.myUserInfo.id);e.index.setStorage({key:o,data:t})}}await r.request({data:{method:"POST",group:"message",action:`${t}/delete`,data:{id:t},header:{"content-type":"application/x-www-form-urlencoded"}}}),e.index.$emit(h.REFRESH_CHAT_CONTENT,{needRefresh:!0})}},async getAllChatHistory(e,t){this.moreText="loading";let a=await r.request({data:{method:"GET",group:"message",action:"history",data:{page:t,userId:e},header:{"content-type":"application/x-www-form-urlencoded"}}});if(a.data.code==i.REQUEST_SUCCEEDED_CODE){let e=a.data.data,s=a.data.data.list;e.pageSum<=t?(this.haveMoreData=!1,this.moreText="noMore"):(this.haveMoreData=!0,this.moreText="more");let o=[];t>1&&(o=this.historyChats),o=o.reverse().concat(s),this.scrollInto=`chat_${s[0].id}`,this.historyChats=o.reverse()}},async getHistoryByDate(e,t,a){let s=await r.request({data:{method:"GET",group:"message",action:"history/byDate",data:{userId:e,date:t,page:a},header:{"content-type":"application/x-www-form-urlencoded"}}});if(s.data.code==i.REQUEST_SUCCEEDED_CODE){let e=s.data.data,t=s.data.data.list;e.pageSum<=a?(this.haveMoreData=!1,this.moreText="noMore"):(this.haveMoreData=!0,this.moreText="more");let o=[];a>1&&(o=this.historyChats),o=o.reverse().concat(t),this.scrollInto=`chat_${t[0].id}`,this.historyChats=o.reverse()}},async getHistoryDateList(e){let t=await r.request({data:{method:"GET",group:"message",action:"history/dateList",data:{userId:e},header:{"content-type":"application/x-www-form-urlencoded"}}});if(t.data.code==i.REQUEST_SUCCEEDED_CODE){let e=t.data.data,a=[];e.forEach((e=>{let t={text:e.month,value:e.month,children:[]};e.day.forEach((e=>{let a={text:e,value:e};t.children.push(a)})),a.push(t)})),this.datePickerList=a}}}};if(!Array){(e.resolveComponent("uni-nav-bar")+e.resolveComponent("uni-load-more")+e.resolveComponent("chat-item")+e.resolveComponent("uni-data-picker")+e.resolveComponent("action-sheet-item")+e.resolveComponent("action-sheet"))()}Math||((()=>"../../../uni_modules/uni-nav-bar/components/uni-nav-bar/uni-nav-bar.js")+(()=>"../../../uni_modules/uni-load-more/components/uni-load-more/uni-load-more.js")+(()=>"../../../components/chat-item/chat-item.js")+(()=>"../../../uni_modules/uni-data-picker/components/uni-data-picker/uni-data-picker.js")+(()=>"../../../components/action-sheet-item/action-sheet-item.js")+(()=>"../../../components/action-sheet/action-sheet.js"))();var l=e._export_sfc(c,[["render",function(t,a,s,o,i,r){return e.e({a:e.o((e=>r.onNarLeftClick())),b:e.p({"left-icon":"back",fixed:"true",backgroundColor:"#fff",color:"#808080",statusBar:"true"}),c:i.historyChats.length>0},i.historyChats.length>0?{d:e.p({status:i.moreText,contentText:{contentdown:"下拉显示更多",contentrefresh:"正在加载...",contentnomore:"没有更多数据了"}}),e:e.f(i.historyChats,((t,a,s)=>e.e({a:r.showChatCreatTime(a)},r.showChatCreatTime(a)?{b:e.t(i.GettimeifferenceOfNow(t.createTime).Detailed)}:{},{c:e.o((e=>r.onChatItemLongPress(t))),d:"66d68366-2-"+s,e:e.p({avatarUrl:t.my?i.myUserInfo.avatar:i.fromUserInfo.avatar,chatText:t.content,isMe:t.my,voiceTime:t.time,messageType:t.type}),f:t.id,g:"chat_"+t.id}))),f:e.o((e=>t.onContentClick())),g:i.scrollInto,h:r.scollerHeight+"px",i:e.o(((...e)=>r.onScrollToUpper&&r.onScrollToUpper(...e)))}:{},{j:i.datePickerList.length>0},i.datePickerList.length>0?{k:e.o(r.onDatePikcerChange),l:e.o(t.onDatePikcerNodeClick),m:e.p({placeholder:"请选择日期",localdata:i.datePickerList,"popup-title":"请选择日期"})}:{},{n:i.selectChatItem.id},i.selectChatItem.id?e.e({o:0==i.selectChatItem.type},0==i.selectChatItem.type?{p:e.o(r.onCopyTextClick),q:e.p({title:"复制"})}:{},{r:1==i.selectChatItem.type},1==i.selectChatItem.type?{s:e.o(r.onAddExpressionClick),t:e.p({title:"添加到表情"})}:{},{v:e.o(r.onDeleteTextClick),w:e.p({title:"删除"})}):{},{x:e.sr("chatItemActionPopup","66d68366-4"),y:e.p({needHead:!0,title:"设置消息",needCancelButton:!0})})}]]);wx.createPage(l);
