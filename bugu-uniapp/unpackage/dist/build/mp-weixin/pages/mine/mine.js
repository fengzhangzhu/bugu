"use strict";var e=require("../../common/vendor.js"),t=require("../../common/constants.js"),i=require("../../utils/request.js"),a=require("../../common/storageFunctions.js"),o=require("../../utils/aes/export.js"),s=require("../../common/requestFunctions.js"),n=require("../../common/storageKeys.js"),r=require("../../common/globalMsgKeys.js"),l=require("../../utils/tabBarBadgeUtils.js");require("../../utils/messageUtils/index.js"),require("../../utils/messageUtils/service.js"),require("../../utils/messageUtils/storage.js"),require("../../utils/messageUtils/storageKeys.js"),require("../../utils/dateUtils.js");const c={data:()=>({isLogin:!0,AnonymousAvatar:t.AnonymousAvatar,privateSettingGroup:t.privateSettingGroup,privateSelected:t.privateSettingGroup[0],isRefresh:!1,userInfo:{},tabSelect:0,myArticles:{data:[],page:1,haveMore:!0},likedArticles:{data:[],page:1,haveMore:!0},editArticleItem:{},numberChange:{followedNumber:0,fansNumber:0,viewsNumber:0},lastClickTime:0}),async onLoad(){let e=await a.getMyUserInfo();if(!e)return this.userInfo={attentionSum:0,visitorSum:0,beAttentionSum:0,avatar:t.AnonymousAvatar,id:-1,registerDay:0,username:"未登录",isVerify:0},void(this.isLogin=!1);this.userInfo=e,this.isLogin=!0,this.refreshUserInfo(),l.changeUnreadMessageSum()},async onShow(){let i=this;e.index.$once(r.REFRESH_USERINFO,(function(e){e.needRefresh&&i.refreshUserInfo()})),e.index.$once(r.LOGOUT,(function(e){e.logout&&(i.userInfo={attentionSum:0,visitorSum:0,beAttentionSum:0,avatar:t.AnonymousAvatar,id:-1,registerDay:0,username:"未登录",isVerify:0},i.isLogin=!1,i.myArticles.data=[],i.myArticles.page=1)}))},methods:{onNavigateTo(t){e.index.navigateTo({url:t})},async refreshUserInfo(){this.userInfo=await a.getMyUserInfo(),this.userInfo?(this.myArticles.page=1,this.initNumberChange(this.userInfo),this.getMyArticle(this.userInfo.id,this.myArticles.page)):(e.index.showModal({title:"未登录",content:"未登录请先登录",success:function(t){t.confirm&&e.index.navigateTo({url:"/pages/login/login"})}}),this.myArticles.data=[],this.myArticles.page=1)},async initNumberChange(t){let i=n.getFollowedNumberChangedKey(t.id),a=n.getFansNumberChangedKey(t.id),o=n.getViewsNumberChangedKey(t.id),r=e.index.getStorageSync(i),l=e.index.getStorageSync(a),c=e.index.getStorageSync(o);r||(r=0),l||(l=0),c||(c=0);let d=await s.getUserinfo(t.id);d&&(this.userInfo=d,r=d.attentionSum-t.attentionSum+r,l=d.beAttentionSum-t.beAttentionSum+l,c=d.visitorSum-t.visitorSum+c,e.index.setStorage({key:n.USER_INFO,data:d}),e.index.setStorage({key:i,data:r>0?r:0}),e.index.setStorage({key:a,data:l>0?l:0}),e.index.setStorage({key:o,data:c>0?c:0}),this.numberChange={followedNumber:r,fansNumber:l,viewsNumber:c})},onSettingButtonClick(){e.index.navigateTo({url:"/pages/setting/setting"})},onBackgroundClick(){let t=Date.now();if(!(t-this.lastClickTime>1e3))return;if(this.lastClickTime=t,this.userInfo||e.index.showToast({title:"请先登录",icon:"none"}),!this.userInfo.vip||this.userInfo.vip.remainDays<1)return void e.index.showToast({title:"只有vip用户可以更换背景哦~",icon:"none"});let i=this;e.index.chooseImage({count:1,sizeType:["original","compressed"],sourceType:["album"],success:function(e){var t=e.tempFilePaths;i.changeBackgroud(t[0])}})},onVipLogoClick(){e.index.navigateTo({url:"/pages/setting/bugu-vip/bugu-vip"})},onFollowedNumberClick(){this.userInfo&&(e.index.navigateTo({url:"/pages/mine-secondary-page/follow-list/follow-list"}),this.numberChange.followedNumber=0)},onFansNumberClick(){this.userInfo&&(e.index.navigateTo({url:"/pages/mine-secondary-page/fan-list/fan-list"}),this.numberChange.fansNumber=0)},onVisitorNumberClick(){this.userInfo&&(e.index.navigateTo({url:"/pages/mine-secondary-page/visitor-list/visitor-list"}),this.numberChange.viewsNumber=0)},async onTabChange(e){if(this.tabSelect=e,1==e&&this.likedArticles.data.length<1&&this.likedArticles.haveMore){this.likedArticles.page=1;let e=await this.getMyLikedArticle(this.userInfo.id,this.likedArticles.page);e.length>0?this.likedArticles.data=e:this.likedArticles.haveMore=!1}},async onRefresh(){this.isRefresh=!0,this.initNumberChange(this.userInfo),this.myArticles.page=1,this.likedArticles.page=1,this.getMyArticle(this.userInfo.id,this.myArticles.page);let e=await this.getMyLikedArticle(this.userInfo.id,this.likedArticles.page);e.length>0?this.likedArticles.data=e:this.likedArticles.haveMore=!1},async onPrivaterAdioChange(t){this.privateSelected=t.detail.value;let i=this.privateSettingGroup.indexOf(this.privateSelected);if(this.editArticleItem.id){e.index.showLoading({title:"权限修改中"});let t=await this.ChangeVisibility(this.editArticleItem.id,i);if(e.index.hideLoading(),t){let t=this.myArticles.data;for(let e=0;e<t.length;e++)if(t[e].id==this.editArticleItem.id){t[e].visibility=i;break}this.myArticles.data=t,e.index.showToast({title:"可见性修改成功！"}),this.$refs.articleActionPopup.close()}else this.privateSelected=this.privateSettingGroup[this.editArticleItem.visibility]}},onActivityDeleteButtonClick(){if(this.editArticleItem.id){let t=this;e.index.showModal({title:"删除动态",content:"你确定要删除这个动态吗",confirmText:"确定",cancelText:"取消",success:async function(i){if(i.confirm){e.index.showLoading({title:"权限修改中"});let i=await s.deleteMyArticle(t.editArticleItem.id);if(e.index.hideLoading(),i){let i=t.myArticles.data;for(let e=0;e<i.length;e++)if(i[e].id==t.editArticleItem.id){i.splice(e,1);break}t.myArticles.data=i,e.index.showToast({title:"删除成功！"}),t.$refs.articleActionPopup.close()}}}})}},onPopupReportClick(i){e.index.navigateTo({url:`/pages/setting/report-user/report-user?objectId=${i.id}&objectType=${t.reportObjectType.activity}`}),this.$refs.articleLikedActionPopup.close()},onActivityItemClick(t){e.index.navigateTo({url:`/pages/activity-info/activity-info?activityId=${t.id}`})},onActivityItemMoreClick(e){this.editArticleItem=e,this.privateSelected=this.privateSettingGroup[e.visibility],this.$refs.articleActionPopup.open()},onActivityLikedItemMoreClick(e){this.editArticleItem=e,this.$refs.articleLikedActionPopup.open()},async onScrolltolower(){if(0==this.tabSelect){if(!this.myArticles.haveMore)return;this.myArticles.page=this.myArticles.page+1,this.getMyArticle(this.userInfo.id,this.myArticles.page)}else if(1==this.tabSelect){this.likedArticles.page=this.likedArticles.page+1;let e=await this.getMyLikedArticle(this.userInfo.id,this.likedArticles.page);e.length>0?this.likedArticles.data=this.likedArticles.data.concat(e):this.likedArticles.haveMore=!1}},async getMyArticle(e,a){let o=await i.request({data:{method:"GET",group:"user",action:`${e}/activity`,data:{userId:e,page:a},header:{"content-type":"application/x-www-form-urlencoded"}}});if(setTimeout((()=>{this.isRefresh=!1}),700),o.data.code===t.REQUEST_SUCCEEDED_CODE){let e=o.data.data,t=o.data.data.list;a<=e.pageSum?(this.myArticles.data=1==a?t:this.myArticles.data.concat(t),a==e.pageSum?this.myArticles.haveMore=!1:this.myArticles.haveMore=!0):(this.myArticles.page=this.myArticles.page-1,this.myArticles.haveMore=!1)}},async getMyLikedArticle(e,a){let o=await i.request({data:{method:"GET",group:"activity",action:"uLikeActivity",data:{uid:e,startPage:a,pageSize:8},header:{"content-type":"application/x-www-form-urlencoded"}}});if(o.data.code===t.REQUEST_SUCCEEDED_CODE){return o.data.data}return[]},ChangeVisibility:async(e,a)=>(await i.request({data:{method:"POST",group:"activity",action:`${e}/visibility/change`,data:{id:e,visibility:a},header:{"content-type":"application/x-www-form-urlencoded"}}})).data.code===t.REQUEST_SUCCEEDED_CODE,async changeBackgroud(a){e.index.showLoading({title:"正在发布"});let s=await i.request({data:{method:"GET",group:"user",action:"background/token",data:{},header:{"content-type":"application/x-www-form-urlencoded"}}});if(s.data.code===t.REQUEST_SUCCEEDED_CODE){let n=s.data.data.fileName,r=s.data.data.token,l=this;e.index.uploadFile({url:t.UploadUrl,filePath:a,name:"file",formData:{key:n,token:o.aes.decrypt(r)},async success(a){(await i.request({data:{method:"POST",group:"user",action:"background/update",data:{background:n},header:{"content-type":"application/x-www-form-urlencoded"}}})).data.code===t.REQUEST_SUCCEEDED_CODE&&(e.index.showToast({title:"更换背景成功"}),l.refreshUserInfo())}})}else e.index.showToast({title:"没有权限，请先登录",icon:"none"})}}};if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-nav-bar")+e.resolveComponent("uni-badge")+e.resolveComponent("user-activity-item")+e.resolveComponent("custom-tab-pane")+e.resolveComponent("custom-tabs")+e.resolveComponent("action-sheet")+e.resolveComponent("action-sheet-item"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-nav-bar/components/uni-nav-bar/uni-nav-bar.js")+(()=>"../../uni_modules/uni-badge/components/uni-badge/uni-badge.js")+(()=>"../../components/user-activity-item/user-activity-item.js")+(()=>"../../components/custom-tab-pane/custom-tab-pane.js")+(()=>"../../components/custom-tabs/custom-tabs.js")+(()=>"../../components/action-sheet/action-sheet.js")+(()=>"../../components/action-sheet-item/action-sheet-item.js"))();var d=e._export_sfc(c,[["render",function(t,i,a,o,s,n){return e.e({a:s.userInfo.id},s.userInfo.id?{b:e.t(s.userInfo.username)}:{},{c:e.p({customPrefix:"customicons",type:"settings-filled",color:"#fdfdfd",size:"25"}),d:e.o(((...e)=>n.onSettingButtonClick&&n.onSettingButtonClick(...e))),e:e.o((e=>t.onNarLeftClick())),f:e.p({fixed:"true",border:!1,backgroundColor:"#ffffff00",color:"#808080",statusBar:"true"}),g:s.userInfo.id},s.userInfo.id?e.e({h:s.userInfo.avatar},s.userInfo.avatar?{i:s.userInfo.avatar}:{},{j:s.userInfo.vip&&s.userInfo.vip.remainDays>0?"../../static/svgs/vip-logo.svg":"../../static/svgs/no-vip-logo.svg",k:e.o((e=>n.onVipLogoClick())),l:e.o((e=>n.onNavigateTo("/pages/setting/personal_information/personal_information"))),m:e.t(s.userInfo.attentionSum),n:s.numberChange.followedNumber>0},s.numberChange.followedNumber>0?{o:e.p({text:s.numberChange.followedNumber,type:"error",size:"small","max-num":99})}:{},{p:e.o(((...e)=>n.onFollowedNumberClick&&n.onFollowedNumberClick(...e))),q:e.t(s.userInfo.beAttentionSum),r:s.numberChange.fansNumber>0},s.numberChange.fansNumber>0?{s:e.p({text:s.numberChange.fansNumber,type:"error",size:"small","max-num":99})}:{},{t:e.o(((...e)=>n.onFansNumberClick&&n.onFansNumberClick(...e))),v:e.t(s.userInfo.visitorSum),w:s.numberChange.viewsNumber>0},s.numberChange.viewsNumber>0?{x:e.p({text:s.numberChange.viewsNumber,type:"error",size:"small","max-num":99})}:{},{y:e.o(((...e)=>n.onVisitorNumberClick&&n.onVisitorNumberClick(...e))),z:s.isLogin},s.isLogin?{A:e.o((e=>n.onNavigateTo("/pages/setting/personal_information/personal_information")))}:{B:e.o((e=>n.onNavigateTo("/pages/login/login")))},{C:e.o((()=>{}))}):{},{D:e.o(((...e)=>n.onBackgroundClick&&n.onBackgroundClick(...e))),E:s.userInfo.background?`url(${s.userInfo.background})`:"linear-gradient(to bottom, #e7d3aa, #61c5ae);",F:s.myArticles.data.length>0},s.myArticles.data.length>0?{G:e.f(s.myArticles.data,((t,i,a)=>({a:e.o((e=>n.onActivityItemClick(t))),b:e.o((e=>n.onActivityItemMoreClick(t))),c:"482491e0-7-"+a+",482491e0-6",d:e.p({articleItem:t,isMe:!0,avatar:s.userInfo.avatar,username:s.userInfo.username}),e:t.id})))}:{},{H:s.isRefresh,I:e.o(((...e)=>n.onScrolltolower&&n.onScrolltolower(...e))),J:e.p({label:"动态"}),K:s.likedArticles.data.length>0},s.likedArticles.data.length>0?{L:e.f(s.likedArticles.data,((t,i,a)=>e.e({a:1!=t.isAnonymity&&t.publisher},1!=t.isAnonymity&&t.publisher?{b:e.o((e=>n.onActivityItemClick(t))),c:e.o((e=>n.onActivityLikedItemMoreClick(t))),d:"482491e0-9-"+a+",482491e0-8",e:e.p({articleItem:t,isMe:t.publisher.id==s.userInfo.id,avatar:t.publisher.avatar,username:t.publisher.username})}:{f:e.o((e=>n.onActivityItemClick(t))),g:e.o((e=>n.onActivityLikedItemMoreClick(t))),h:"482491e0-10-"+a+",482491e0-8",i:e.p({articleItem:t,isMe:!1,avatar:s.AnonymousAvatar,username:"匿名用户"})},{j:t.id})))}:{},{M:s.isRefresh,N:e.o(((...e)=>n.onScrolltolower&&n.onScrolltolower(...e))),O:e.p({label:"赞过"}),P:e.o(n.onTabChange),Q:e.p({index:s.tabSelect,animation:!0,tabPadding:"40",flex:!0}),R:s.editArticleItem.id},s.editArticleItem.id?{S:e.f(s.privateSettingGroup,((t,i,a)=>({a:e.t(t),b:t,c:t===s.privateSelected,d:t}))),T:e.o(((...e)=>n.onPrivaterAdioChange&&n.onPrivaterAdioChange(...e))),U:e.o(((...e)=>n.onActivityDeleteButtonClick&&n.onActivityDeleteButtonClick(...e)))}:{},{V:e.sr("articleActionPopup","482491e0-11"),W:e.p({needHead:!0,title:"动态设置"}),X:s.editArticleItem.id},s.editArticleItem.id?{Y:e.o((e=>n.onPopupReportClick(s.editArticleItem))),Z:e.p({icon:"icon-alert",title:"举报"})}:{},{aa:e.sr("articleLikedActionPopup","482491e0-12"),ab:e.p({needHead:!0,title:"动态设置"})})}]]);wx.createPage(d);
