"use strict";var e=require("../../common/vendor.js"),t=require("./storageKeys.js"),a=require("../dateUtils.js"),s=require("../../common/constants.js"),r=require("../../common/requestFunctions.js");const n=[s.InteractiveType.LIKE,s.InteractiveType.AGREE],i=[s.InteractiveType.COMMENT,s.InteractiveType.ANSWER];async function d(a,r){let n=t.getChatRecordKey(a,r),i=e.index.getStorageSync(n);return i||(i={fromUserId:r,type:s.USER_MESSAGE,badgeNumber:0,messages:[]}),i}async function g(a){let s=t.getUserMessageListKey(a),r=e.index.getStorageSync(s);return r||(r=[]),r}async function o(a,s){let r=t.getInteractiveMessageListKey(a,s),n=e.index.getStorageSync(r);return n&&n.data||(n={unreadSum:0,data:[]}),n}async function c(a){let s=t.getOfficeNewsListKey(a),r=e.index.getStorageSync(s);return r||(r=[]),r}exports.commentGroup=i,exports.deleteAllInteractiveMessage=async function(a,s){let r=t.getInteractiveMessageListKey(a,s);e.index.setStorage({key:r,data:null})},exports.deleteMessageRecord=async function(a){let s=t.getInteractiveMessageListKey(a,"LIKE");e.index.setStorage({key:s,data:null});let r=t.getInteractiveMessageListKey(a,"COMMENT");e.index.setStorage({key:r,data:null});let n=t.getUserMessageListKey(a);(await g(a)).forEach((s=>{let r=t.getChatRecordKey(a,s.userId);e.index.setStorage({key:r,data:null})})),e.index.setStorage({key:n,data:null})},exports.deleteOfficalNewsItem=async function(a,s){let r=await c(a),n=t.getOfficeNewsListKey(a);for(let i=0;i<r.length;i++)if(r[i].type===s){let n=t.getOfficeTypeNewsListKey(a,s);e.index.setStorage({key:n,data:null}),r.splice(i,1);break}return e.index.setStorage({key:n,data:r}),r},exports.deleteUserMessageItem=async function(a,s){let r=await g(a),n=t.getUserMessageListKey(a);for(let i=0;i<r.length;i++)if(r[i].userId==s){let n=t.getChatRecordKey(a,s);e.index.setStorage({key:n,data:null}),r.splice(i,1);break}return e.index.setStorage({key:n,data:r}),r},exports.getChatRecord=d,exports.getInteractiveMessageList=o,exports.getOfficalList=c,exports.getTypeOfficalNews=async function(a,s){let r=t.getOfficeTypeNewsListKey(a,s),n=e.index.getStorageSync(r);return n||(n=[]),n},exports.getUserMessageList=g,exports.interactiveMessageALLRead=async function(a,s){let r=t.getInteractiveMessageListKey(a,s),n=await o(a,s);n.unreadSum=0,e.index.setStorage({key:r,data:n})},exports.likeGroup=n,exports.saveAlreadyRead=async function(a,s){let r=t.getChatRecordKey(s,a.data.userId),n=await d(s,a.data.userId),i=n.messages;for(let e=0;e<i.length;e++)i[e].isMe&&(i[e].isNotRead=!1);n.messages=i,e.index.setStorage({key:r,data:n})},exports.saveChatRecord=async function(s,r){let n=t.getChatRecordKey(r,s.data.fromUserId),i=await d(r,s.data.fromUserId),g=i.messages;g.push({content:s.data.content,type:s.data.type,id:s.data.id,createTime:a.getTime(),isMe:!1,time:s.data.time}),i.badgeNumber=i.badgeNumber+1,i.messages=g,e.index.setStorage({key:n,data:i})},exports.saveInteractiveMessageItem=async function(r,d){let g,c;console.log("new_message",r),n.includes(r.data.type)?(g=t.getInteractiveMessageListKey(d,"LIKE"),c=await o(d,"LIKE")):i.includes(r.data.type)?(g=t.getInteractiveMessageListKey(d,"COMMENT"),c=await o(d,"COMMENT")):r.data.type===s.InteractiveType.PUBLISH?(g=t.getInteractiveMessageListKey(d,"PUBLISH"),c=await o(d,"PUBLISH")):r.data.type===s.InteractiveType.ATTENTION&&(g=t.getInteractiveMessageListKey(d,"ATTENTION"),c=await o(d,"ATTENTION")),r.data.createTime=a.getTime(),c.data.push(r.data),c.unreadSum=c.unreadSum+1,e.index.setStorage({key:g,data:c})},exports.saveInteractiveMessageList=async function(a,s,r){if(a.length<1)return;let n=t.getInteractiveMessageListKey(s,r),i=await o(s,r);i.data=a.concat(i.data),i.unreadSum=i.unreadSum+a.length,e.index.setStorage({key:n,data:i})},exports.saveUserMessageList=async function(s,n){let i=t.getUserMessageListKey(n),d=await g(n),o=!1;for(let t=0;t<d.length;t++)if(s.data.fromUserId==d[t].userId){d.push({avatar:d[t].avatar,lastMessage:s.data.content,lastMessageType:s.data.type,lastTime:a.getTime(),online:d[t].online,unReadSum:d[t].unReadSum+1,userId:d[t].userId,username:d[t].username}),d.splice(t,1),o=!0,e.index.setStorage({key:i,data:d});break}if(!o){let e=await r.getUserinfo(s.data.fromUserId);e&&d.push({avatar:e.avatar,lastMessage:s.data.content,lastMessageType:s.data.type,lastTime:a.getTime(),online:!0,unReadSum:1,userId:e.id,username:e.username})}e.index.setStorage({key:i,data:d})},exports.saveUserMessageListWhenWithDraw=async function(s,n){let i=t.getUserMessageListKey(n),d=await g(n),o=!1;for(let e=0;e<d.length;e++)if(s.data.userId==d[e].userId){d[e]={avatar:d[e].avatar,lastMessage:"对方撤回了一条消息",lastMessageType:-1,lastTime:d[e].lastTime,online:d[e].online,unReadSum:d[e].unReadSum,userId:d[e].userId,username:d[e].username},o=!0;break}if(!o){let e=await r.getUserinfo(s.data.userId);e&&d.push({avatar:e.avatar,lastMessage:"对方撤回了一条消息",lastMessageType:-1,lastTime:a.getTime(),online:!0,unReadSum:0,userId:e.id,username:e.username})}e.index.setStorage({key:i,data:d})},exports.saveWithDrawChatRecord=async function(a,s){let r=t.getChatRecordKey(s,a.data.userId),n=await d(s,a.data.userId),i=n.messages;for(let e=i.length-1;e>=0;e--)i[e].id==a.data.messageId&&(i[e]={id:a.data.messageId,type:-1,content:"对方撤回了一条消息",createTime:i[e].createTime,isMe:!1});n.messages=i,e.index.setStorage({key:r,data:n})};
